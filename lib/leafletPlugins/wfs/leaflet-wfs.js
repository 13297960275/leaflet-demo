"use strict";L.XmlUtil={namespaces:{xlink:"http://www.w3.org/1999/xlink",xmlns:"http://www.w3.org/2000/xmlns/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},xmldoc:(new DOMParser).parseFromString("<root />","text/xml"),setAttributes:function(e,t){for(var i in t)if(null!=t[i]&&t[i].toString){var n=t[i].toString(),r=this.namespaces[i.substring(0,i.indexOf(":"))]||null;e.setAttributeNS(r,i,n)}},evaluate:function(e,t){var i=(new DOMParser).parseFromString(t,"text/xml"),n=new XPathEvaluator,r=n.createNSResolver(i.documentElement);return n.evaluate(e,i,r,XPathResult.ANY_TYPE,null)},createElementNS:function(e,t,i){var n=(i=i||{}).uri;n||(n=this.namespaces[e.substring(0,e.indexOf(":"))]),n||(n=this.namespaces[i.prefix]);var r=n?this.xmldoc.createElementNS(n,e):this.xmldoc.createElement(e);return t&&this.setAttributes(r,t),null!=i.value&&r.appendChild(this.xmldoc.createTextNode(i.value)),r},createTextNode:function(e){return e||0===e?this.xmldoc.createTextNode(e):this.xmldoc.createTextNode("")},getNodeText:function(e){return e?e.innerText||e.textContent||e.text:""},serializeXmlDocumentString:function(e){var t=document.implementation.createDocument("","",null);return t.appendChild(e),(new XMLSerializer).serializeToString(t)},serializeXmlToString:function(e){return(new XMLSerializer).serializeToString(e)},parseXml:function(e){if(void 0!==window.DOMParser)return(new window.DOMParser).parseFromString(e,"text/xml");if(void 0!==window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var t=new window.ActiveXObject("Microsoft.XMLDOM");return t.async="false",t.loadXML(e),t}throw new Error("No XML parser found")},parseOwsExceptionReport:function(e){var t=L.XmlUtil.parseXml(e).documentElement;if(!t||"ows:ExceptionReport"!==t.tagName)return null;for(var i={exceptions:[],message:""},n=t.getElementsByTagNameNS(L.XmlUtil.namespaces.ows,"Exception"),r=0,o=n.length;r<o;r++){for(var a=n[r],s=a.getAttribute("exceptionCode"),l=a.getElementsByTagNameNS(L.XmlUtil.namespaces.ows,"ExceptionText"),p={code:s,text:""},u=0,c=l.length;u<c;u++){var h=l[u],m=h.innerText||h.textContent||h.text;p.text+=m,u<c-1&&(p.text+=". ")}i.message+=p.code+" - "+p.text,r<o-1&&(i.message+=" "),i.exceptions.push(p)}return i}},L.Util.request=function(e){e=L.extend({async:!0,method:"POST",data:"",params:{},headers:{},url:window.location.href,success:function(e){console.log(e)},error:function(e){console.log("Ajax request fail"),console.log(e)},complete:function(){}},e);var t=new XMLHttpRequest;t.onreadystatechange=function(){4===t.readyState&&(200===t.status?e.success(t.responseText):e.error(t.responseText),e.complete())};var i=e.url+L.Util.getParamString(e.params,e.url);for(var n in t.open(e.method,i,e.async),e.headers)t.setRequestHeader(n,e.headers[n]);t.send(e.data)},L.Filter={},L.filter=function(e){var t=L.XmlUtil.createElementNS("ogc:Filter");return Array.isArray(e)?e.forEach(function(e){t.appendChild(e.toGml())}):e&&t.appendChild(e.toGml()),t},L.Filter.propertyName=function(e){return L.XmlUtil.createElementNS("ogc:PropertyName",{},{value:e})},L.Filter.literal=function(e){return L.XmlUtil.createElementNS("ogc:Literal",{},{value:e})},L.Filter.element=function(e){return e instanceof Element?e:e.toGml()},L.Filter.propertyElement=function(e){return e instanceof Element?e:e&&"function"==typeof e.toGml?e.toGml():L.Filter.propertyName(e)},L.Filter.literalElement=function(e){return e instanceof Element?e:e&&"function"==typeof e.toGml?e.toGml():L.Filter.literal(e)},L.Filter.Abstract=L.Class.extend({attributes:{},options:{},tagName:null,buildFilterContent:function(){throw"Build filter content is abstract and should be implemented"},toGml:function(){var e=L.XmlUtil.createElementNS(this.tagName,this.attributes,this.options);return this.buildFilterContent(e),e}}),L.Filter.BinarySpatial=L.Filter.Abstract.extend({initialize:function(e,t,i){this.propertyName=e,this.value=t,this.crs=i},buildFilterContent:function(e){return e.appendChild(L.Filter.propertyName(this.propertyName)),"string"==typeof this.value?e.appendChild(L.Filter.propertyName(this.value)):e.appendChild(this.value.toGml(this.crs)),e}}),L.Filter.Equals=L.Filter.BinarySpatial.extend({tagName:"ogc:Equals"}),L.Filter.equals=function(e){return new L.Filter.Equals(e)},L.Filter.Disjoint=L.Filter.BinarySpatial.extend({tagName:"ogc:Disjoint"}),L.Filter.disjoint=function(e){return new L.Filter.Disjoint(e)},L.Filter.Touches=L.Filter.BinarySpatial.extend({tagName:"ogc:Touches"}),L.Filter.touches=function(e){return new L.Filter.Touches(e)},L.Filter.Within=L.Filter.BinarySpatial.extend({tagName:"ogc:Within"}),L.Filter.within=function(e){return new L.Filter.Within(e)},L.Filter.Overlaps=L.Filter.BinarySpatial.extend({tagName:"ogc:Overlaps"}),L.Filter.overlaps=function(e){return new L.Filter.Overlaps(e)},L.Filter.Crosses=L.Filter.BinarySpatial.extend({tagName:"ogc:Crosses"}),L.Filter.crosses=function(e){return new L.Filter.Crosses(e)},L.Filter.Intersects=L.Filter.BinarySpatial.extend({tagName:"ogc:Intersects"}),L.Filter.intersects=function(e){return new L.Filter.Intersects(e)},L.Filter.Contains=L.Filter.BinarySpatial.extend({tagName:"ogc:Contains"}),L.Filter.contains=function(e){return new L.Filter.Contains(e)},L.Filter.DistanceBuffer=L.Filter.Abstract.extend({initialize:function(e,t,i,n,r){this.propertyName=e,this.geomerty=t,this.crs=i,this.distance=n,this.units=r},buildFilterContent:function(e){e.appendChild(L.Filter.propertyName(this.propertyName)),e.appendChild(this.geomerty.toGml(this.crs)),e.appendChild(L.XmlUtil.createElementNS("ogc:Distance",{units:this.units},{value:this.distance}))}}),L.Filter.DWithin=L.Filter.DistanceBuffer.extend({tagName:"ogc:DWithin"}),L.Filter.dwithin=function(e,t,i,n,r){return new L.Filter.DWithin(e,t,i,n,r)},L.Filter.Beyond=L.Filter.DistanceBuffer.extend({tagName:"ogc:Beyond"}),L.Filter.beyond=function(e,t,i,n,r){return new L.Filter.Beyond(e,t,i,n,r)},L.Filter.BBox=L.Filter.Abstract.extend({tagName:"ogc:BBOX",geometryField:null,bbox:null,crs:null,initialize:function(e,t,i){this.bbox=t,this.geometryField=e,this.crs=i},buildFilterContent:function(e){this.geometryField&&e.appendChild(L.Filter.propertyName(this.geometryField)),e.appendChild(this.bbox.toGml(this.crs))}}),L.Filter.bbox=function(e,t,i){return new L.Filter.BBox(e,t,i)},L.Filter.GmlObjectID=L.Filter.Abstract.extend({tagName:"ogc:GmlObjectId",initialize:function(e){this.attributes={"gml:id":e}},buildFilterContent:function(){}}),L.Filter.gmlobjectid=function(e){return new L.Filter.GmlObjectID(e)},L.Filter.BinaryOperator=L.Filter.Abstract.extend({initialize:function(e,t){this.firstValue=e,this.secondValue=t},buildFilterContent:function(e){e.appendChild(L.Filter.propertyElement(this.firstValue)),e.appendChild(L.Filter.literalElement(this.secondValue))}}),L.Filter.Add=L.Filter.BinaryOperator.extend({tagName:"Add"}),L.Filter.add=function(e,t){return new L.Filter.Add(e,t)},L.Filter.Sub=L.Filter.BinaryOperator.extend({tagName:"Sub"}),L.Filter.sub=function(e,t){return new L.Filter.Sub(e,t)},L.Filter.Mul=L.Filter.BinaryOperator.extend({tagName:"Mul"}),L.Filter.mul=function(e,t){return new L.Filter.Mul(e,t)},L.Filter.Div=L.Filter.BinaryOperator.extend({tagName:"Div"}),L.Filter.div=function(e,t){return new L.Filter.Div(e,t)},L.Filter.BinaryComparison=L.Filter.BinaryOperator.extend({attributes:{matchCase:!1},initialize:function(e,t,i){L.Filter.BinaryOperator.prototype.initialize.call(this,e,t),this.attributes.matchCase=!!i}}),L.Filter.EQ=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsEqualTo"}),L.Filter.eq=function(e,t){return new L.Filter.EQ(e,t)},L.Filter.NotEQ=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsNotEqualTo"}),L.Filter.neq=function(e,t){return new L.Filter.NotEQ(e,t)},L.Filter.LT=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsLessThan"}),L.Filter.lt=function(e,t){return new L.Filter.LT(e,t)},L.Filter.GT=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsGreaterThan"}),L.Filter.gt=function(e,t){return new L.Filter.GT(e,t)},L.Filter.LEQ=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsLessThanOrEqualTo"}),L.Filter.leq=function(e,t){return new L.Filter.LEQ(e,t)},L.Filter.GEQ=L.Filter.BinaryComparison.extend({tagName:"ogc:PropertyIsGreaterThanOrEqualTo"}),L.Filter.geq=function(e,t){return new L.Filter.GEQ(e,t)},L.Filter.Like=L.Filter.Abstract.extend({tagName:"ogc:PropertyIsLike",attributes:{wildCard:"*",singleChar:"#",escapeChar:"!",matchCase:!0},initialize:function(e,t,i){this.name=e,this.val=t,this.attributes=L.extend(this.attributes,i||{})},buildFilterContent:function(e){var t=L.Filter.propertyName(this.name),i=L.Filter.literal(this.val);return e.appendChild(t),e.appendChild(i),e}}),L.Filter.like=function(e,t,i){return new L.Filter.Like(e,t,i)},L.Filter.IsNull=L.Filter.Abstract.extend({tagName:"ogc:PropertyIsNull",initialize:function(e){this.propertyName=e},buildFilterContent:function(e){e.appendChild(L.Filter.propertyName(this.propertyName))}}),L.Filter.isnull=function(e){return new L.Filter.IsNull(e)},L.Filter.IsBetween=L.Filter.Abstract.extend({tagName:"ogc:PropertyIsBetween",initialize:function(e,t,i){this.property=e,this.lowerBoundary=t,this.upperBoundary=i},buildFilterContent:function(e){e.appendChild(L.Filter.propertyElement(this.property));var t=L.XmlUtil.createElementNS("ogc:LowerBoundary");t.appendChild(L.Filter.literalElement(this.lowerBoundary)),e.appendChild(t);var i=L.XmlUtil.createElementNS("ogc:UpperBoundary");i.appendChild(L.Filter.literalElement(this.upperBoundary)),e.appendChild(i)}}),L.Filter.isbetween=function(e,t,i){return new L.Filter.IsBetween(e,t,i)},L.Filter.BinaryLogic=L.Filter.Abstract.extend({filters:null,initialize:function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.filters=e},buildFilterContent:function(t){this.filters.forEach(function(e){t.appendChild(L.Filter.element(e))})}}),L.Filter.And=L.Filter.BinaryLogic.extend({tagName:"And"}),L.Filter.and=function(){return new(Function.prototype.bind.apply(L.Filter.And,arguments))},L.Filter.Or=L.Filter.BinaryLogic.extend({tagName:"Or"}),L.Filter.or=function(){return new(Function.prototype.bind.apply(L.Filter.Or,arguments))},L.Filter.Not=L.Filter.Abstract.extend({tagName:"Not",initialize:function(e){this.filter=e},buildFilterContent:function(e){e.appendChild(L.Filter.element(this.filter))}}),L.Filter.not=function(e){return new L.Filter.Not(e)},L.Filter.Function=L.Filter.Abstract.extend({tagName:"Function",initialize:function(){var e=arguments[0];this.attributes={name:e};for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);this.expressions=t},buildFilterContent:function(e){var t=this.expressions[0];e.appendChild(L.Filter.propertyElement(t));for(var i=1;i<this.expressions.length;i++){var n=this.expressions[i];e.appendChild(L.Filter.literalElement(n))}}}),L.Filter.function=function(){return new(Function.prototype.bind.apply(L.Filter.Function,arguments))},L.Format={},L.Format.Scheme=L.Class.extend({options:{geometryField:"Shape"},initialize:function(e){L.setOptions(this,e)},parse:function(e){for(var t=new L.GML.FeatureType({geometryField:this.options.geometryField}),i=e.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"complexType")[0].getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"sequence")[0],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];if(r.nodeType===document.ELEMENT_NODE)if(r.attributes.name){var o=r.attributes.name.value;if(o!==this.options.geometryField){var a=r.attributes.type;if(!a)a=r.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"restriction").attributes.base;if(a){var s=a.value.split(":").pop();t.appendField(o,s)}}}}return t}}),L.Format.Base=L.Class.extend({defaultOptions:{crs:L.CRS.EPSG3857,coordsToLatLng:function(e){return new L.LatLng(e[1],e[0],e[2])},latLngToCoords:function(e){var t=[e.lng,e.lat];return void 0!==e.alt&&t.push(e.alt),t},geometryField:"Shape"},initialize:function(e){if(L.setOptions(this,L.extend({},this.defaultOptions,e)),e.crs){var n=e.crs;this.options.coordsToLatLng=function(e){var t=L.point(e[0],e[1]),i=n.projection.unproject(t);return e[2]&&(i.alt=e[2]),i},this.options.latLngToCoords=function(e){var t=L.latLng(e);return n.projection.project(t)}}},setFeatureDescription:function(e){this.namespaceUri=e.attributes.targetNamespace.value;var t=new L.Format.Scheme({geometryField:this.options.geometryField});this.featureType=t.parse(e)}}),L.Format.GeoJSON=L.Format.Base.extend({initialize:function(e){L.Format.Base.prototype.initialize.call(this,e),this.outputFormat="application/json"},responseToLayers:function(e,t){if(t)for(var i in t)t[i]&&(this.options[i]=t[i]);for(var n=[],r=JSON.parse(e),o=0;o<r.features.length;o++)n.push(this.processFeature(r.features[o]));return n},processFeature:function(e){var t=this.generateLayer(e);return t.feature=e,t},generateLayer:function(e){return L.GeoJSON.geometryToLayer(e,this.options||null)}}),L.GML=L.GML||{},L.GML.ParserContainerMixin={parsers:{},initializeParserContainer:function(){this.parsers={}},appendParser:function(e){this.parsers[e.elementTag]=e},parseElement:function(e,t){var i=this.parsers[e.tagName];if(!i)throw"unknown child element "+e.tagName;return i.parse(e,t)}},L.GML.Element=L.Class.extend({elementTag:"",parse:function(){throw"not implemented parse function in parser for "+this.elementTag}}),L.GML.Geometry=L.GML.Element.extend({statics:{DIM:2},dimensions:function(e){return e.attributes.srsDimension?parseInt(e.attributes.srsDimension.value):L.GML.Geometry.DIM}}),L.GML.Coordinates=L.GML.Element.extend({defaultSeparator:{ds:".",cs:",",ts:" "},initialize:function(){this.elementTag="gml:coordinates"},parse:function(e){var t=this.defaultSeparator.ds;e.attributes.decimal&&(t=e.attributes.decimal.value);var i=this.defaultSeparator.cs;e.attributes.cs&&(i=e.attributes.cs.value);var n=this.defaultSeparator.ts;e.attributes.ts&&(n=e.attributes.ts.value);for(var r=[],o=e.textContent.split(n),a=function(e){return"."!==t&&(e=e.replace(t,".")),parseFloat(e)},s=0;s<o.length;s++)r.push(o[s].split(i).map(a));return 1===r.length?r[0]:r}}),L.GML.Pos=L.GML.Element.extend({initialize:function(){this.elementTag="gml:pos"},parse:function(e){return e.textContent.split(" ").map(function(e){return parseFloat(e)})}}),L.GML.PosList=L.GML.Element.extend({initialize:function(){this.elementTag="gml:posList"},parse:function(e,t){for(var i=[],n=t.dimensions,r=e.textContent.split(" "),o=0;o<r.length;o+=n){for(var a=[],s=o;s<o+n;s++)a.push(parseFloat(r[s]));i.push(a)}return i}}),L.GML.PointNode=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.elementTag="gml:Point",this.initializeParserContainer(),this.appendParser(new L.GML.Pos),this.appendParser(new L.GML.Coordinates)},parse:function(e){return this.parseElement(e.firstChild,{dimensions:this.dimensions(e)})}}),L.GML.PointSequence=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.initializeParserContainer(),this.appendParser(new L.GML.Pos),this.appendParser(new L.GML.PosList),this.appendParser(new L.GML.Coordinates),this.appendParser(new L.GML.PointNode)},parse:function(e){var t=e.firstChild,i=[],n=t.tagName;if("gml:pos"===n||"gml:Point"===n)for(var r=this.parsers[n],o=e.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,n.split(":").pop()),a=0;a<o.length;a++)i.push(r.parse(o[a]));else i=this.parseElement(t,{dimensions:this.dimensions(e)});return i}}),L.GML.LinearRing=L.GML.PointSequence.extend({initialize:function(){L.GML.PointSequence.prototype.initialize.call(this),this.elementTag="gml:LinearRing"},parse:function(e){var t=L.GML.PointSequence.prototype.parse.call(this,e);return t.pop(),t}}),L.GML.LineStringNode=L.GML.PointSequence.extend({initialize:function(){this.elementTag="gml:LineString",L.GML.PointSequence.prototype.initialize.call(this)},parse:function(e){return L.GML.PointSequence.prototype.parse.call(this,e)}}),L.GML.PolygonNode=L.GML.Geometry.extend({initialize:function(){this.elementTag="gml:Polygon",this.linearRingParser=new L.GML.LinearRing},parse:function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];n.nodeType===document.ELEMENT_NODE&&t.push(this.linearRingParser.parse(n.firstChild))}return t}}),L.GML.CoordsToLatLngMixin={transform:function(e,t){if(Array.isArray(e[0])){for(var i=[],n=0;n<e.length;n++)i.push(this.transform(e[n],t));return i}return t.coordsToLatLng(e)}},L.GML.Point=L.GML.PointNode.extend({includes:L.GML.CoordsToLatLngMixin,parse:function(e,t){var i=L.GML.PointNode.prototype.parse.call(this,e),n=new L.Marker;return n.setLatLng(this.transform(i,t)),n}}),L.GML.LineString=L.GML.LineStringNode.extend({includes:L.GML.CoordsToLatLngMixin,parse:function(e,t){var i=new L.Polyline([]),n=L.GML.LineStringNode.prototype.parse.call(this,e);return i.setLatLngs(this.transform(n,t)),i}}),L.GML.Polygon=L.GML.PolygonNode.extend({includes:L.GML.CoordsToLatLngMixin,parse:function(e,t){var i=new L.Polygon([]),n=L.GML.PolygonNode.prototype.parse.call(this,e);return i.setLatLngs(this.transform(n,t)),i}}),L.GML.MultiGeometry=L.GML.Geometry.extend({includes:[L.GML.ParserContainerMixin,L.GML.CoordsToLatLngMixin],initialize:function(){this.initializeParserContainer()},parse:function(e,t){for(var i=[],n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType===document.ELEMENT_NODE)for(var o=0;o<r.childNodes.length;o++){var a=r.childNodes[o];a.nodeType===document.ELEMENT_NODE&&i.push(this.parseElement(a,t))}}return this.transform(i,t)}}),L.GML.AbstractMultiPolyline=L.GML.MultiGeometry.extend({initialize:function(){L.GML.MultiGeometry.prototype.initialize.call(this),this.appendParser(new L.GML.LineStringNode)},parse:function(e,t){var i=L.GML.MultiGeometry.prototype.parse.call(this,e,t),n=new L.Polyline([]);return n.setLatLngs(i),n}}),L.GML.AbstractMultiPolygon=L.GML.MultiGeometry.extend({initialize:function(){L.GML.MultiGeometry.prototype.initialize.call(this),this.appendParser(new L.GML.PolygonNode)},parse:function(e,t){var i=L.GML.MultiGeometry.prototype.parse.call(this,e,t),n=new L.Polygon([]);return n.setLatLngs(i),n}}),L.GML.MultiLineString=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this),this.elementTag="gml:MultiLineString"}}),L.GML.MultiCurve=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this),this.elementTag="gml:MultiCurve"}}),L.GML.MultiPolygon=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this),this.elementTag="gml:MultiPolygon"}}),L.GML.MultiSurface=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this),this.elementTag="gml:MultiSurface"}}),L.GML.MultiPoint=L.GML.MultiGeometry.extend({initialize:function(){L.GML.MultiGeometry.prototype.initialize.call(this),this.elementTag="gml:MultiPoint",this.appendParser(new L.GML.PointNode)},parse:function(e,t){for(var i=L.GML.MultiGeometry.prototype.parse.call(this,e,t),n=new L.FeatureGroup,r=0;r<i.length;r++){var o=new L.Marker;o.setLatLng(i[r]),n.addLayer(o)}return n}}),L.GML.FeatureType=L.Class.extend({options:{geometryField:"Shape"},primitives:[{types:["byte","decimal","int","integer","long","short"],parse:function(e){return Number(e)}},{types:["string"],parse:function(e){return e}},{types:["boolean"],parse:function(e){return"false"!==e}},{types:["date","time","datetime"],parse:function(e){return new Date(e)}}],initialize:function(e){L.setOptions(this,e),this.fields={}},appendField:function(t,i){var n=this;this.primitives.forEach(function(e){-1!==e.types.indexOf(i)&&(n.fields[t]=e.parse)})},parse:function(e){for(var t={},i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(n.nodeType===document.ELEMENT_NODE){var r=n.tagName.split(":").pop();if(r!==this.options.geometryField){var o=this.fields[r];o||(this.appendField(r,"string"),o=this.fields[r]),t[r]=o(n.textContent)}}}return{type:"Feature",properties:t,id:e.attributes["gml:id"].value}}}),L.Format.GML=L.Format.Base.extend({includes:L.GML.ParserContainerMixin,initialize:function(e){L.Format.Base.prototype.initialize.call(this,e),this.outputFormat="text/xml; subtype=gml/3.1.1",this.initializeParserContainer(),this.appendParser(new L.GML.Point),this.appendParser(new L.GML.LineString),this.appendParser(new L.GML.Polygon),this.appendParser(new L.GML.MultiLineString),this.appendParser(new L.GML.MultiPolygon),this.appendParser(new L.GML.MultiCurve),this.appendParser(new L.GML.MultiSurface),this.appendParser(new L.GML.MultiPoint)},responseToLayers:function(e){for(var t=[],i=L.XmlUtil.parseXml(e).documentElement,n=i.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMember"),r=0;r<n.length;r++){var o=n[r].firstChild;t.push(this.processFeature(o))}var a=i.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMembers");if(0<a.length)for(var s=a[0].childNodes,l=0;l<s.length;l++){var p=s[l];p.nodeType===document.ELEMENT_NODE&&t.push(this.processFeature(p))}return t},processFeature:function(e){var t=this.generateLayer(e);return t.feature=this.featureType.parse(e),t},generateLayer:function(e){var t=e.getElementsByTagNameNS(this.namespaceUri,this.options.geometryField)[0];if(!t)throw new Error("Geometry field '"+this.options.geometryField+"' doesn' exist inside received feature: '"+e.innerHTML+"'");return this.parseElement(t.firstChild,this.options)}}),L.Util.project=function(t,e){if(L.Util.isArray(e)){var i=[];return e.forEach(function(e){i.push(L.Util.project(t,e))}),i}return t.projection.project(e)},L.GmlUtil={posNode:function(e){return L.XmlUtil.createElementNS("gml:pos",{srsDimension:2},{value:e.x+" "+e.y})},posListNode:function(e,t){var i=[];if(e.forEach(function(e){i.push(e.x+" "+e.y)}),t&&0<e.length){var n=e[0];i.push(n.x+" "+n.y)}var r=i.join(" ");return L.XmlUtil.createElementNS("gml:posList",{},{value:r})}},L.CircleMarker.include({toGml:function(e){var t=L.XmlUtil.createElementNS("gml:Point",{srsName:e.code});return t.appendChild(L.GmlUtil.posNode(L.Util.project(e,this.getLatLng()))),t}}),L.LatLngBounds.prototype.toGml=function(e){var t=e.project(this.getSouthWest()),i=e.project(this.getNorthEast()),n=L.XmlUtil.createElementNS("gml:Envelope",{srsName:e.code});return n.appendChild(L.XmlUtil.createElementNS("gml:lowerCorner",{},{value:t.x+" "+t.y})),n.appendChild(L.XmlUtil.createElementNS("gml:upperCorner",{},{value:i.x+" "+i.y})),n},L.Marker.include({toGml:function(e){var t=L.XmlUtil.createElementNS("gml:Point",{srsName:e.code});return t.appendChild(L.GmlUtil.posNode(L.Util.project(e,this.getLatLng()))),t}}),L.Polygon.include({toGml:function(e){for(var t=this.getLatLngs(),i=[],n=0;n<t.length;n++){var r=t[n],o=L.Polyline._flat(r),a=L.XmlUtil.createElementNS("gml:Polygon",{srsName:e.code,srsDimension:2});if(a.appendChild(L.XmlUtil.createElementNS("gml:exterior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GmlUtil.posListNode(L.Util.project(e,o?r:r[0]),!0)),!o)for(var s=1;s<r.length;s++)a.appendChild(L.XmlUtil.createElementNS("gml:interior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GmlUtil.posListNode(L.Util.project(e,r[s]),!0));i.push(a)}if(1===i.length)return i[0];for(var l=L.XmlUtil.createElementNS("gml:MultiPolygon",{srsName:e.code,srsDimension:2}),p=l.appendChild(L.XmlUtil.createElementNS("gml:polygonMembers")),u=0;u<i.length;u++)p.appendChild(i[u]);return l}}),L.Polyline.include({_lineStringNode:function(e,t){var i=L.XmlUtil.createElementNS("gml:LineString",{srsName:e.code,srsDimension:2});return i.appendChild(L.GmlUtil.posListNode(L.Util.project(e,t),!1)),i},toGml:function(e){var t=this.getLatLngs();if(L.Polyline._flat(t))return this._lineStringNode(e,t);for(var i=L.XmlUtil.createElementNS("gml:MultiLineString",{srsName:e.code,srsDimension:2}),n=i.appendChild(L.XmlUtil.createElementNS("gml:lineStringMembers")),r=0;r<t.length;r++)n.appendChild(this._lineStringNode(e,t[r]));return i}});var PropertiesMixin={setProperties:function(e){for(var t in e)e.hasOwnProperty(t)&&(this.feature.properties[t]=e[t])},getProperty:function(e){return this.feature.properties[e]},deleteProperties:function(e){for(var t=0;t<e.length;t++)this.feature.properties.hasOwnProperty(e[t])&&delete this.feature.properties[e[t]]}};L.Marker.include(PropertiesMixin),L.Path.include(PropertiesMixin),L.WFSLayer=L.VirtualGrid.extend({options:{version:"1.1.0",namespaceUri:"",crs:L.CRS.EPSG4326,geometryField:"Shape",url:"",typeNS:"",typeName:"",maxFeatures:2e3,filter:null,showExisting:!0,opacity:1,style:{color:"black",weight:1,opacity:1,fillOpacity:1}},_capabilities:null,_boundingBox:null,state:{},initialize:function(e,t){L.VirtualGrid.prototype.initialize.call(this,e),L.Util.setOptions(this,e),this.options.crs=this.options.crs||L.CRS.EPSG4326;var r=this;this.options.symbol&&this.options.symbol.iconOptions&&(this.options.pointToLayer=function(e,t){var i=e.properties,n=L.mars.layer.getMarkerOptionsByConfig(r.options,i);return L.marker(t,n)}),this.options.symbol&&this.options.symbol.styleOptions&&(this.options.style=function(e){var t=e.properties;return L.mars.layer.getPolyOptionsByConfig(r.options,t)}),this._layers={},this._cache={},this._currentSnapshot=[],this.state={exist:"exist"},this.readFormat=t||new L.Format.GeoJSON({crs:this.options.crs,geometryField:this.options.geometryField}),this.options.typeNSName=this.namespaceName(this.options.typeName),this.options.srsName=this.options.crs.code;r=this;this.describeFeatureType(function(){},function(e){r.fire("error",{error:new Error(e)})})},onAdd:function(e){for(var t in this._layers)e.addLayer(this._layers[t]);return e.on("zoomend",this._handleZoomChange,this),L.VirtualGrid.prototype.onAdd.call(this,e)},onRemove:function(e){for(var t in this._layers)e.removeLayer(this._layers[t]);return e.off("zoomend",this._handleZoomChange,this),L.VirtualGrid.prototype.onRemove.call(this,e)},_cacheKey:function(e){return e.z+":"+e.x+":"+e.y},_visibleZoom:function(){if(!this._map)return!1;var e=this._map.getZoom();return!(e>this.options.maxZoom||e<this.options.minZoom)},createCell:function(e,t){if(this._visibleZoom()&&this.options.showExisting){this.loadFeatures(this.options.filter,e,t,function(e,t){null==e||console.log(e,"服务访问出错")})}},cellEnter:function(e,n){this._visibleZoom()&&!this._zooming&&this._map&&L.Util.requestAnimFrame(L.Util.bind(function(){var e=this._cacheKey(n),t=this._cellCoordsToKey(n),i=this._cache[e];this._activeCells[t]&&i&&this.addLayers(i)},this))},cellLeave:function(e,s){this._zooming||L.Util.requestAnimFrame(L.Util.bind(function(){if(this._map){var e=this._cacheKey(s),t=this._cellCoordsToKey(s),i=this._cache[e],n=this._map.getBounds();if(!this._activeCells[t]&&i){for(var r=!0,o=0;o<i.length;o++){var a=this._layers[i[o]];a&&a.getBounds&&n.intersects(a.getBounds())&&(r=!1)}r&&this.removeLayers(i,!this.options.cacheLayers),!this.options.cacheLayers&&r&&(delete this._cache[e],delete this._cells[t],delete this._activeCells[t])}}},this))},_handleZoomChange:function(){if(this._visibleZoom())for(var e in this._activeCells){var t=this._activeCells[e].coords,i=this._cacheKey(t);this._cache[i]&&this.addLayers(this._cache[i])}else this.removeLayers(this._currentSnapshot),this._currentSnapshot=[]},namespaceName:function(e){return this.options.typeNS+":"+e},setOpacity:function(e){return this.options.opacity=e,this._updateOpacity(),this},_updateOpacity:function(){L.extend(this.options.style||{},{opacity:this.options.opacity,fillOpacity:this.options.opacity})},describeFeatureType:function(n,r){var e=L.XmlUtil.createElementNS("wfs:DescribeFeatureType",{service:"WFS",version:this.options.version});e.appendChild(L.XmlUtil.createElementNS("TypeName",{},{value:this.options.typeNSName}));var o=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(e),headers:this.options.headers||{},success:function(e){var t=L.XmlUtil.parseOwsExceptionReport(e);if(t)"function"==typeof r&&r(t.message);else{var i=L.XmlUtil.parseXml(e).documentElement;o.readFormat.setFeatureDescription(i),o.options.namespaceUri=i.attributes.targetNamespace.value,"function"==typeof n&&n()}},error:function(e){"function"==typeof r&&r(e)}})},bindGetFeature:function(e,t){var i=L.XmlUtil.createElementNS("wfs:GetFeature",{service:"WFS",version:this.options.version,maxFeatures:this.options.maxFeatures,outputFormat:this.readFormat.outputFormat}),n=i.appendChild(L.XmlUtil.createElementNS("wfs:Query",{typeName:this.options.typeNSName,srsName:this.options.srsName}));if(e&&n.appendChild(L.filter(e)),t){var r=new L.Filter.BBox(this.options.geometryField,t,L.CRS.EPSG4326);n.appendChild(L.filter(r))}return i},query:function(e,t){this.loadFeatures(e,null,null,t)},loadFeatures:function(e,t,n,r){if(n){var i=this._cacheKey(n),o=this._cache[i];if(o&&0<o.length)return}var a=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(a.bindGetFeature(e,t)),headers:this.options.headers||{},success:function(e){var t=L.XmlUtil.parseOwsExceptionReport(e);if(t)return a.fire("error",{error:new Error(t.message)}),a;var i=a.readFormat.responseToLayers(e,{coordsToLatLng:a.options.coordsToLatLng,pointToLayer:a.options.pointToLayer,style:a.options.style});return i&&0<i.length&&a._addFeatures(i,n),r(null,i),a},error:function(e){return r(e,null),a}})},_addFeatures:function(e,t){var i;t&&(i=this._cacheKey(t),this._cache[i]=this._cache[i]||[]);for(var n=e.length-1;0<=n;n--){var r=e[n].feature.id;t&&(-1===this._currentSnapshot.indexOf(r)&&this._currentSnapshot.push(r),-1===this._cache[i].indexOf(r)&&this._cache[i].push(r));var o,a=this._layers[r];if(this._visibleZoom()&&a&&!this._map.hasLayer(a)&&this._map.addLayer(a),null==a){o=e[n];r.split(".");o.addEventParent(this),this.options.onEachFeature&&this.options.onEachFeature(o.feature,o),this._layers[r]=o,this.setFeatureStyle(r,this.options.style);var s=this.options;(this.options.popup||this.options.columns)&&o.bindPopup(function(e){var t=e.feature.properties,i=s.popupNameField?t[s.popupNameField]:s.name;return L.mars.layer.getPopup(s.popup||s.columns,t,i)},{maxWidth:600}),this.options.tooltip&&o.bindTooltip(function(e){var t=e.feature.properties,i=s.popupNameField?t[s.popupNameField]:s.name;return L.mars.layer.getPopup(s.tooltip,t,i)},{className:"leafletlayer-tooltip",direction:"top"}),this._visibleZoom()&&this._map.addLayer(o)}else e[n]=a}},eachFeature:function(e,t){for(var i in this._layers)e.call(t,this._layers[i]);return this},setStyle:function(t){return this.options.style=t,this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this),this},setFeatureStyle:function(e,t){var i=this._layers[e];return"function"==typeof t&&(t=t(i.feature)),i.setStyle&&i.setStyle(t),this},addLayers:function(e){for(var t=e.length-1;0<=t;t--){var i=this._layers[e[t]];i&&this._map.addLayer(i)}},removeLayers:function(e,t){for(var i=e.length-1;0<=i;i--){var n=e[i],r=this._layers[n];r&&this._map.removeLayer(r),r&&t&&delete this._layers[n]}},getFeature:function(e){return this._layers[e]},bringToBack:function(){this.eachFeature(function(e){e.bringToBack&&e.bringToBack()})},bringToFront:function(){this.eachFeature(function(e){e.bringToFront&&e.bringToFront()})}}),L.wfsLayer=function(e){return new L.WFSLayer(e)};