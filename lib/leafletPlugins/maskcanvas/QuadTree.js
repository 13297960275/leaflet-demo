!function(t){function s(t,i,e,n){var h;h=i?new o(t,0,e,n):new r(t,0,e,n),this.root=h}function o(t,i,e,n){this._bounds=t,this.children=[],this.nodes=[],n&&(this._maxChildren=n),e&&(this._maxDepth=e),i&&(this._depth=i)}function r(t,i,e,n){o.call(this,t,i,e,n),this._stuckChildren=[]}s.prototype.root=null,s.prototype.insert=function(t){if(t instanceof Array)for(var i=t.length,e=0;e<i;e++)this.root.insert(t[e]);else this.root.insert(t)},s.prototype.clear=function(){this.root.clear()},s.prototype.retrieve=function(t){return this.root.retrieve(t).slice(0)},s.prototype.retrieveInBounds=function(t){var i=this.root.retrieveInBounds(t);return s._filterResults(i,t)},s._filterResults=function(t,i){var e=[];if(this.root instanceof r)for(var n=0;n<t.length;n++){var h=t[n];s._isBoundOverlappingBound(h,i)&&e.push(h)}else t.forEach(function(t){s._isPointInsideBounds(t,i)&&e.push(t)});return e},s._isPointInsideBounds=function(t,i){return t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height},s._isBoundOverlappingBound=function(t,i){return!(t.x>i.x+i.width||i.x>t.x+t.width||t.y>i.y+i.height||i.y>t.y+t.height)},o.prototype.nodes=null,(o.prototype._classConstructor=o).prototype.children=null,o.prototype._bounds=null,o.prototype._depth=0,o.prototype._maxChildren=4,o.prototype._maxDepth=4,o.TOP_LEFT=0,o.TOP_RIGHT=1,o.BOTTOM_LEFT=2,o.BOTTOM_RIGHT=3,o.prototype.insert=function(t){if(this.nodes.length){var i=this._findIndex(t);this.nodes[i].insert(t)}else{this.children.push(t);var e=this.children.length;if(!(this._depth>=this._maxDepth)&&e>this._maxChildren){this.subdivide();for(var n=0;n<e;n++)this.insert(this.children[n]);this.children.length=0}}},o.prototype.retrieve=function(t){if(this.nodes.length){var i=this._findIndex(t);return this.nodes[i].retrieve(t)}return this.children},o.prototype.retrieveInBounds=function(t){var i=[];if(this.collidesWith(t))if(i=i.concat(this._stuckChildren),this.children.length)i=i.concat(this.children);else if(this.nodes.length)for(var e=0;e<this.nodes.length;e++)i=i.concat(this.nodes[e].retrieveInBounds(t));return i},o.prototype.collidesWith=function(t){var i=this._bounds,e=t;return!(i.x>e.x+e.width||e.x>i.x+i.width||i.y>e.y+e.height||e.y>i.y+i.height)},o.prototype._findIndex=function(t){var i=this._bounds,e=!(t.x>i.x+i.width/2),n=!(t.y>i.y+i.height/2),h=o.TOP_LEFT;return e?n||(h=o.BOTTOM_LEFT):h=n?o.TOP_RIGHT:o.BOTTOM_RIGHT,h},o.prototype.subdivide=function(){var t=this._depth+1,i=this._bounds.x,e=this._bounds.y,n=this._bounds.width/2|0,h=this._bounds.height/2|0,s=i+n,r=e+h;this.nodes[o.TOP_LEFT]=new this._classConstructor({x:i,y:e,width:n,height:h},t,this._maxDepth,this._maxChildren),this.nodes[o.TOP_RIGHT]=new this._classConstructor({x:s,y:e,width:n,height:h},t,this._maxDepth,this._maxChildren),this.nodes[o.BOTTOM_LEFT]=new this._classConstructor({x:i,y:r,width:n,height:h},t,this._maxDepth,this._maxChildren),this.nodes[o.BOTTOM_RIGHT]=new this._classConstructor({x:s,y:r,width:n,height:h},t,this._maxDepth,this._maxChildren)},o.prototype.clear=function(){this.children.length=0;for(var t=this.nodes.length,i=0;i<t;i++)this.nodes[i].clear();this.nodes.length=0},((r.prototype=new o)._classConstructor=r).prototype._stuckChildren=null,r.prototype._out=[],r.prototype.insert=function(t){if(this.nodes.length){var i=this._findIndex(t),e=this.nodes[i];t.x>=e._bounds.x&&t.x+t.width<=e._bounds.x+e._bounds.width&&t.y>=e._bounds.y&&t.y+t.height<=e._bounds.y+e._bounds.height?this.nodes[i].insert(t):this._stuckChildren.push(t)}else{this.children.push(t);var n=this.children.length;if(this._depth<this._maxDepth&&n>this._maxChildren){this.subdivide();for(var h=0;h<n;h++)this.insert(this.children[h]);this.children.length=0}}},r.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)},r.prototype.retrieve=function(t){var i=this._out;if(i.length=0,this.nodes.length){var e=this._findIndex(t);i.push.apply(i,this.nodes[e].retrieve(t))}return i.push.apply(i,this._stuckChildren),i.push.apply(i,this.children),i},r.prototype.clear=function(){this._stuckChildren.length=0,this.children.length=0;var t=this.nodes.length;if(t){for(var i=0;i<t;i++)this.nodes[i].clear();this.nodes.length=0}},t.QuadTree=s}(this);