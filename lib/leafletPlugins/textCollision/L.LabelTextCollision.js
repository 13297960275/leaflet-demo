L.LabelTextCollision=L.Canvas.extend({options:{collisionFlg:!0},initialize:function(t){L.Util.setOptions(this,t),L.Util.stamp(this),this._layers=this._layers||{}},_handleMouseHover:function(t,e){var i,o;for(i in this._drawnLayers)(o=this._drawnLayers[i]).options.interactive&&o._containsPoint(e)&&(L.DomUtil.addClass(this._containerText,"leaflet-interactive"),this._fireEvent([o],t,"mouseover"),this._hoveredLayer=o);this._hoveredLayer&&this._fireEvent([this._hoveredLayer],t)},_handleMouseOut:function(t,e){var i=this._hoveredLayer;!i||"mouseout"!==t.type&&i._containsPoint(e)||(L.DomUtil.removeClass(this._containerText,"leaflet-interactive"),this._fireEvent([i],t,"mouseout"),this._hoveredLayer=null)},_updateTransform:function(t,e){L.Canvas.prototype._updateTransform.call(this,t,e);var i=this._map.getZoomScale(e,this._zoom),o=L.DomUtil.getPosition(this._container),n=this._map.getSize().multiplyBy(.5+this.options.padding),s=this._map.project(this._center,e),a=this._map.project(t,e).subtract(s),r=n.multiplyBy(-i).add(o).add(n).subtract(a);L.Browser.any3d?L.DomUtil.setTransform(this._containerText,r,i):L.DomUtil.setPosition(this._containerText,r)},_initContainer:function(t){L.Canvas.prototype._initContainer.call(this),this._containerText=document.createElement("canvas"),this._containerText.id="canvasLayer",this._containerText.style.position="absolute",this._containerText.style.top=0,this._containerText.style.left=0,L.DomEvent.on(this._containerText,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this).on(this._containerText,"click dblclick mousedown mouseup contextmenu",this._onClick,this).on(this._containerText,"mouseout",this._handleMouseOut,this),this._ctxLabel=this._containerText.getContext("2d"),L.DomUtil.addClass(this._containerText,"leaflet-zoom-animated"),this.getPane().appendChild(this._containerText)},_update:function(){this._textList=[],L.Renderer.prototype._update.call(this);var t=this._bounds,e=this._containerText,i=t.getSize(),o=L.Browser.retina?2:1;L.DomUtil.setPosition(e,t.min),e.width=o*i.x,e.height=o*i.y,e.style.width=i.x+"px",e.style.height=i.y+"px",e.style.zIndex="4",this._container.style.zIndex="3",L.Browser.retina&&this._ctxLabel.scale(2,2),this._ctxLabel.translate(-t.min.x,-t.min.y),L.Canvas.prototype._update.call(this)},_updatePoly:function(t,e){L.Canvas.prototype._updatePoly.call(this,t,e),this._text(this._ctxLabel,t)},_updateCircle:function(t){L.Canvas.prototype._updateCircle.call(this,t),this._text(this._ctxLabel,t)},_text:function(t,e){var i=e.options.text;if(null!=i){var o=e.options.textStyle||{};t.save(),t.globalAlpha=1;var n=e._point;if(null==n){if(0==e._parts.length||0==e._parts[0].length)return;n=this._getCenter(e._parts[0])}var s=o.offsetX||0,a=o.offsetY||0;if(t.lineWidth=4,t.font=o.font||"16px 'Microsoft Yahei'",this.options.collisionFlg){for(var r=t.measureText(i).width+n.x,l=n.y+a+20,h=L.bounds(L.point(n.x+s,n.y+a),L.point(r,l)),_=0;_<this._textList.length;_++){if(this._textList[_].intersects(h))return}this._textList.push(h)}o.stroke&&(t.strokeStyle=o.strokeColor||"white",t.strokeText(i,n.x+s,n.y+a)),t.fillStyle=o.color||"blue",o.rotate?(t.translate(n.x,n.y),t.rotate(o.rotate*Math.PI/180),t.fillText(i,0,0),t.restore()):t.fillText(i,n.x+s,n.y+a)}},_getCenter:function(t){var e,i,o,n,s,a,r,l=t.length;if(!l)return null;for(i=e=0;e<l-1;e++)i+=t[e].distanceTo(t[e+1])/2;if(0===i)return t[0];for(n=e=0;e<l-1;e++)if(s=t[e],a=t[e+1],i<(n+=o=s.distanceTo(a))){r=(n-i)/o;var h=[a.x-r*(a.x-s.x),a.y-r*(a.y-s.y)];return L.point(h[0],h[1])}}});