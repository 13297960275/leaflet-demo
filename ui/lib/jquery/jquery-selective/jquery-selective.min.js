
!function(l,i,r,c){"use strict";var n=r.Selective=function(t,e){this.el=t,this.$el=r(t).css({display:"none"})||r("<select></select>"),this.options=r.extend(!0,{},n.defaults,e),this.namespace=this.options.namespace;var i=this,s=r(this.options.tpl.frame.call(this));this.$select=!0===this.$el.is("select")?this.$el:(i.$el.html(i.options.tpl.select.call(i)),i.$el.children("select")),this.$el.after(s),this._init(),this.opened=!1};n.defaults={namespace:"selective",buildFromHtml:!0,closeOnSelect:!1,local:null,selected:null,withSearch:!1,searchType:null,ajax:{work:!1,url:null,quietMills:null,loadMore:!1,pageSize:null},tpl:{frame:function(){return'<div class="'+this.namespace+'"><div class="'+this.namespace+'-trigger">'+this.options.tpl.triggerButton.call(this)+'<div class="'+this.namespace+'-trigger-dropdown"><div class="'+this.namespace+'-list-wrap">'+this.options.tpl.list.call(this)+"</div></div></div>"+this.options.tpl.items.call(this)+"</div>"},search:function(){return'<input class="'+this.namespace+'-search" type="text" placeholder="Search...">'},select:function(){return'<select class="'+this.namespace+'-select" name="'+this.namespace+'" multiple="multiple"></select>'},optionValue:function(t){return t.name},option:function(t){return'<option value="'+this.options.tpl.optionValue.call(this)+'">'+t+"</option>"},items:function(){return'<ul class="'+this.namespace+'-items"></ul>'},item:function(t){return'<li class="'+this.namespace+'-item">'+t+this.options.tpl.itemRemove.call(this)+"</li>"},itemRemove:function(){return'<span class="'+this.namespace+'-remove">x</span>'},triggerButton:function(){return'<div class="'+this.namespace+'-trigger-button">Add</div>'},list:function(){return'<ul class="'+this.namespace+'-list"></ul>'},listItem:function(t){return'<li class="'+this.namespace+'-list-item">'+t+"</li>"}},query:function(){},onBeforeShow:null,onAfterShow:null,onBeforeHide:null,onAfterHide:null,onBeforeSearch:null,onAfterSearch:null,onBeforeSelected:null,onAfterSelected:null,onBeforeUnselect:null,onAfterUnselect:null,onBeforeItemRemove:null,onAfterItemRemove:null,onBeforeItemAdd:null,onAfterItemAdd:null},n.prototype={constructor:n,_list:{build:function(n,i){var o=r("<ul></ul>"),t=n._options.getOptions(n);return!0===n.options.buildFromHtml?0!==t.length&&r.each(t,function(t,e){var i=r(n.options.tpl.listItem.call(n,e.text)),s=r(e);n.setIndex(i,s),s.attr("selected")!==c&&n.select(i),o.append(i)}):null!==i&&(r.each(i,function(t){var e=r(n.options.tpl.listItem.call(n,i[t]));n.setIndex(e,i[t]),o.append(e)}),0!==t.length&&r.each(t,function(t,e){var i=r(e),s=n.getItem("li",o,n.options.tpl.optionValue(i.data("selective_index")));s!==c&&n._list.select(n,s)})),n.$list.append(o.children("li")),n},buildSearch:function(t){return!0===t.options.withSearch&&(t.$triggerDropdown.prepend(t.options.tpl.search.call(t)),t.$search=t.$triggerDropdown.find("."+t.namespace+"-search")),t},select:function(t,e){return t._trigger("beforeSelected"),e.addClass(t.namespace+"-selected"),t._trigger("afterSelected"),t},unselect:function(t,e){return t._trigger("beforeUnselected"),e.removeClass(t.namespace+"-selected"),t._trigger("afterUnselected"),t},click:function(e){e.$list.on("click","li",function(){var t=r(this);t.hasClass(e.namespace+"-selected")||e.select(t)})},filter:function(t,e){return r.expr[":"].Contains=function(t,e,i){return 0<=jQuery(t).text().toUpperCase().indexOf(i[3].toUpperCase())},e?(t.$list.find("li:not(:Contains("+e+"))").slideUp(),t.$list.find("li:Contains("+e+")").slideDown()):t.$list.children("li").slideDown(),t},loadMore:function(t,e){return(e||9999)>t.page&&t.$listWrap.on("scroll.selective",function(){0===t.$list.outerHeight()-t.$listWrap.height()-t.$listWrap.scrollTop()&&t.options.query(t,t.$search.val(),++t.page)}),t},loadMoreRemove:function(t){return t.$listWrap.off("scroll.selective"),t}},_options:{getOptions:function(t){return t.$options=t.$select.find("option"),t.$options},select:function(t,e){return e.prop("selected",!0),t},unselect:function(t,e){return e.prop("selected",!1),t},add:function(t,e){if(!1===t.options.buildFromHtml&&t.getItem("option",t.$select,t.options.tpl.optionValue(e))===c){var i=r(t.options.tpl.option.call(t,e));return t.setIndex(i,e),t.$select.append(i),i}},remove:function(t,e){return e.remove(),t}},_items:{withDefaults:function(e,i){null!==i&&r.each(i,function(t){e._options.add(e,i[t]),e._options.select(e,e.getItem("option",e.$select,e.options.tpl.optionValue(i[t]))),e._items.add(e,i[t])})},add:function(t,e,i){var s,n;n=!0===t.options.buildFromHtml?i:e,s=r(t.options.tpl.item.call(t,n)),t.setIndex(s,e),t.$items.append(s)},remove:function(t,e){var i,s;return!0===t.options.buildFromHtml?(t._list.unselect(t,e.data("selective_index")),t._options.unselect(t,e.data("selective_index").data("selective_index"))):((i=t.getItem("li",t.$list,t.options.tpl.optionValue(e.data("selective_index"))))!==c&&t._list.unselect(t,i),s=t.getItem("option",t.$select,t.options.tpl.optionValue(e.data("selective_index"))),t._options.unselect(t,s)._options.remove(t,s)),e.remove(),t},click:function(e){e.$items.on("click","."+e.namespace+"-remove",function(){var t=r(this).parents("li");e.itemRemove(t)})}},_search:{change:function(t){t.$search.change(function(){t._trigger("beforeSearch"),!0===t.options.buildFromHtml?t._list.filter(t,t.$search.val()):""!==t.$search.val()?(t.page=1,t.options.query(t,t.$search.val(),t.page)):t.update(t.options.local),t._trigger("afterSearch")})},keyup:function(e){var i,s=e.options.ajax.quietMills||1e3,n="",o="";e.$search.on("keyup",function(t){e._trigger("beforeSearch"),o=e.$search.val(),!0===e.options.buildFromHtml?o!==n&&e._list.filter(e,o):(o!==n||13===t.keyCode)&&(l.clearTimeout(i),i=l.setTimeout(function(){""!==o?(e.page=1,e.options.query(e,o,e.page)):e.update(e.options.local)},s)),n=o,e._trigger("afterSearch")})},bind:function(t,e){"change"===e?this.change(t):"keyup"===e&&this.keyup(t)}},_init:function(){this.$selective=this.$el.next("."+this.namespace),this.$items=this.$selective.find("."+this.namespace+"-items"),this.$trigger=this.$selective.find("."+this.namespace+"-trigger"),this.$triggerButton=this.$selective.find("."+this.namespace+"-trigger-button"),this.$triggerDropdown=this.$selective.find("."+this.namespace+"-trigger-dropdown"),this.$listWrap=this.$selective.find("."+this.namespace+"-list-wrap"),this.$list=this.$selective.find("."+this.namespace+"-list"),this._items.withDefaults(this,this.options.selected),this.update(this.options.local)._list.buildSearch(this);var t=this;t.$triggerButton.on("click",function(){!1===t.opened?t.show(t):!0===t.opened&&t.hide(t)}),this._list.click(this),this._items.click(this),!0===this.options.withSearch&&this._search.bind(this,this.options.searchType)},_trigger:function(t){var e=Array.prototype.slice.call(arguments,1),i=[this].concat(e);this.$el.trigger("selective::"+t,i);var s="on"+(t=t.replace(/\b\w+\b/g,function(t){return t.substring(0,1).toUpperCase()+t.substring(1)}));"function"==typeof this.options[s]&&this.options[s].apply(this,e)},_show:function(){var e=this;return r(i).on("click.selective",function(t){!0===e.options.closeOnSelect?0===r(t.target).closest(e.$triggerButton).length&&0===r(t.target).closest(e.$search).length&&e._hide(e):0===r(t.target).closest(e.$trigger).length&&e._hide(e)}),e.$trigger.addClass(e.namespace+"-active"),(e.opened=!0)===e.options.ajax.loadMore&&e._list.loadMore(e),e},_hide:function(){var t=this;return r(i).off("click.selective"),t.$trigger.removeClass(t.namespace+"-active"),!(t.opened=!1)===t.options.ajax.loadMore&&t._list.loadMoreRemove(t),t},show:function(){return this._trigger("beforeShow"),this._show(this),this._trigger("afterShow"),this},hide:function(){return this._trigger("beforeHide"),this._hide(this),this._trigger("afterHide"),this},select:function(t){this._list.select(this,t);var e=t.data("selective_index");return!0===this.options.buildFromHtml?(this._options.select(this,e),this.itemAdd(t,e.text())):(this._options.add(this,e),this._options.select(this,this.getItem("option",this.$select,this.options.tpl.optionValue(e))),this.itemAdd(e)),this},unselect:function(t){return this._list.unselect(this,t),this},setIndex:function(t,e){return t.data("selective_index",e),this},getItem:function(t,e,i){for(var s=e.children(t),n="",o=0;o<s.length;o++)this.options.tpl.optionValue(s.eq(o).data("selective_index"))===i&&(n=o);return""===n?c:s.eq(n)},itemAdd:function(t,e){return this._trigger("beforeItemAdd"),this._items.add(this,t,e),this._trigger("afterItemAdd"),this},itemRemove:function(t){return this._trigger("beforeItemRemove"),this._items.remove(this,t),this._trigger("afterItemRemove"),this},optionAdd:function(t){return this._options.add(this,t),this},optionRemove:function(t){return this._options.remove(this,t),this},update:function(t){return this.$list.empty(),this.page=1,null!==t?this._list.build(this,t):this._list.build(this),this}},r.fn.selective=function(t){if("string"!=typeof t)return this.each(function(){r.data(this,"selective")||r.data(this,"selective",new n(this,t))});var e=t,i=Array.prototype.slice.call(arguments,1);if(/^\_/.test(e))return!1;if(!/^(get)$/.test(e))return this.each(function(){var t=r.data(this,"selective");t&&"function"==typeof t[e]&&t[e].apply(t,i)});var s=this.first().data("selective");return s&&"function"==typeof s[e]?s[e].apply(s,i):void 0}}(window,document,jQuery);