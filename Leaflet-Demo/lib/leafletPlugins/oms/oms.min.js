(function(){(function(){var l={}.hasOwnProperty,a=[].slice;null!=this.L&&(this.OverlappingMarkerSpiderfier=function(){function t(t,e){var r,i,s,n,a=this;for(r in this.map=t,null==e&&(e={}),e)l.call(e,r)&&(i=e[r],this[r]=i);for(this.initMarkerArrays(),this.listeners={},i=0,s=(n=["click","zoomend"]).length;i<s;i++)r=n[i],this.map.addEventListener(r,function(){return a.unspiderfy()})}var e,h;return(e=t.prototype).VERSION="0.2.6",h=2*Math.PI,e.keepSpiderfied=!1,e.nearbyDistance=20,e.circleSpiralSwitchover=9,e.circleFootSeparation=50,e.circleStartAngle=h/12,e.spiralFootSeparation=28,e.spiralLengthStart=11,e.spiralLengthFactor=5,e.legWeight=1.5,e.legColors={usual:"#222",highlighted:"#f00"},e.initMarkerArrays=function(){return this.markers=[],this.markerListeners=[]},e.addMarker=function(t){var e,r=this;return null!=t._oms||(t._oms=!0,e=function(){return r.spiderListener(t)},t.addEventListener("click",e),this.markerListeners.push(e),this.markers.push(t)),this},e.getMarkers=function(){return this.markers.slice(0)},e.removeMarker=function(t){var e,r;return null!=t._omsData&&this.unspiderfy(),(e=this.arrIndexOf(this.markers,t))<0||(r=this.markerListeners.splice(e,1)[0],t.removeEventListener("click",r),delete t._oms,this.markers.splice(e,1)),this},e.clearMarkers=function(){var t,e,r,i,s;for(this.unspiderfy(),t=r=0,i=(s=this.markers).length;r<i;t=++r)e=s[t],t=this.markerListeners[t],e.removeEventListener("click",t),delete e._oms;return this.initMarkerArrays(),this},e.addListener=function(t,e){var r,i;return(null!=(i=(r=this.listeners)[t])?i:r[t]=[]).push(e),this},e.removeListener=function(t,e){var r;return(r=this.arrIndexOf(this.listeners[t],e))<0||this.listeners[t].splice(r,1),this},e.clearListeners=function(t){return this.listeners[t]=[],this},e.trigger=function(){var t,e,r,i,s,n;for(e=arguments[0],t=2<=arguments.length?a.call(arguments,1):[],n=[],i=0,s=(e=null!=(r=this.listeners[e])?r:[]).length;i<s;i++)r=e[i],n.push(r.apply(null,t));return n},e.generatePtsCircle=function(t,e){var r,i,s,n,a;for(s=this.circleFootSeparation*(2+t)/h,i=h/t,a=[],r=n=0;0<=t?n<t:t<n;r=0<=t?++n:--n)r=this.circleStartAngle+r*i,a.push(new L.Point(e.x+s*Math.cos(r),e.y+s*Math.sin(r)));return a},e.generatePtsSpiral=function(t,e){var r,i,s,n,a;for(s=this.spiralLengthStart,a=[],i=n=r=0;0<=t?n<t:t<n;i=0<=t?++n:--n)r+=this.spiralFootSeparation/s+5e-4*i,i=new L.Point(e.x+s*Math.cos(r),e.y+s*Math.sin(r)),s+=h*this.spiralLengthFactor/r,a.push(i);return a},e.spiderListener=function(t){var e,r,i,s,n,a,h,l,o;if((e=null!=t._omsData)&&this.keepSpiderfied||this.unspiderfy(),e)return this.trigger("click",t);for(s=[],n=[],a=this.nearbyDistance*this.nearbyDistance,i=this.map.latLngToLayerPoint(t.getLatLng()),h=0,l=(o=this.markers).length;h<l;h++)e=o[h],this.map.hasLayer(e)&&(r=this.map.latLngToLayerPoint(e.getLatLng()),this.ptDistanceSq(r,i)<a?s.push({marker:e,markerPt:r}):n.push(e));return 1===s.length?this.trigger("click",t):this.spiderfy(s,n)},e.makeHighlightListeners=function(t){var e=this;return{highlight:function(){return t._omsData.leg.setStyle({color:e.legColors.highlighted})},unhighlight:function(){return t._omsData.leg.setStyle({color:e.legColors.usual})}}},e.spiderfy=function(s,t){var e,n,a,h,l,o,i,u,g,r;return this.spiderfying=!0,r=s.length,e=this.ptAverage(function(){var t,e,r;for(r=[],t=0,e=s.length;t<e;t++)i=s[t],r.push(i.markerPt);return r}()),h=r>=this.circleSpiralSwitchover?this.generatePtsSpiral(r,e).reverse():this.generatePtsCircle(r,e),e=function(){var t,e,r,i=this;for(r=[],t=0,e=h.length;t<e;t++)a=h[t],n=this.map.layerPointToLatLng(a),g=this.minExtract(s,function(t){return i.ptDistanceSq(t.markerPt,a)}),o=g.marker,l=new L.Polyline([o.getLatLng(),n],{color:this.legColors.usual,weight:this.legWeight,clickable:!1}),this.map.addLayer(l),o._omsData={usualPosition:o.getLatLng(),leg:l},this.legColors.highlighted!==this.legColors.usual&&(u=this.makeHighlightListeners(o),o._omsData.highlightListeners=u,o.addEventListener("mouseover",u.highlight),o.addEventListener("mouseout",u.unhighlight)),o.setLatLng(n),o.setZIndexOffset(1e6),r.push(o);return r}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",e,t)},e.unspiderfy=function(t){var e,r,i,s,n,a,h;if(null==t&&(t=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,s=[],i=[],n=0,a=(h=this.markers).length;n<a;n++)null!=(e=h[n])._omsData?(this.map.removeLayer(e._omsData.leg),e!==t&&e.setLatLng(e._omsData.usualPosition),e.setZIndexOffset(0),null!=(r=e._omsData.highlightListeners)&&(e.removeEventListener("mouseover",r.highlight),e.removeEventListener("mouseout",r.unhighlight)),delete e._omsData,s.push(e)):i.push(e);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",s,i),this},e.ptDistanceSq=function(t,e){var r,i;return(r=t.x-e.x)*r+(i=t.y-e.y)*i},e.ptAverage=function(t){var e,r,i,s,n;for(s=r=i=0,n=t.length;s<n;s++)r+=(e=t[s]).x,i+=e.y;return t=t.length,new L.Point(r/t,i/t)},e.minExtract=function(t,e){var r,i,s,n,a,h;for(s=a=0,h=t.length;a<h;s=++a)n=e(n=t[s]),(null==r||n<i)&&(i=n,r=s);return t.splice(r,1)[0]},e.arrIndexOf=function(t,e){var r,i,s;if(null!=t.indexOf)return t.indexOf(e);for(r=i=0,s=t.length;i<s;r=++i)if(t[r]===e)return r;return-1},t}())}).call(this)}).call(this);