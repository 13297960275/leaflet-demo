!function(e){function d(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function h(e,t){var i,r={};return e/=M,i=(t/=M)<=0?90:1<=t?-90:(2*g(n(G*(1-2*t)))-U)/G*180,r.latitude=i,r.longitude=360*(1===e?1:(e%1+1)%1)-180,r}function v(e,t){var i=x(1,b(0,.5-s(c(Y+U*e/180))/G/2));return{x:(t/360+.5)*M<<0,y:i*M<<0}}function u(e){for(var t=$+te,i=K+ie,r=0,o=e.length-3;r<o;r+=2)if(e[r]>te&&e[r]<t&&e[r+1]>ie&&e[r+1]<i)return!0;return!1}function r(e){T=Q+e.x,j=K+e.y,we.render(!0)}function o(e){$=e.width,K=e.height,ee=K/2<<0,T=Q=$/2<<0,j=K,we.setSize($,K),P=400}function a(e){M=256<<(H=e);var t=v((e=h(te+Q,ie+ee)).latitude,0);le=v(e.latitude,1).x-t.x,fe=w(.95,H-15),ne=""+re.alpha(fe),se=""+oe.alpha(fe),he=""+ae.alpha(fe)}var n=(t=Math).exp,s=t.log,l=t.sin,f=t.cos,c=t.tan,g=t.atan,p=t.atan2,x=t.min,b=t.max,y=t.sqrt,m=t.ceil,w=t.pow,k=k||Array,_=_||Array,t=/iP(ad|hone|od)/g.test(navigator.userAgent),i=!!~navigator.userAgent.indexOf("Trident"),S=!e.requestAnimationFrame||t||i?function(e){e()}:e.requestAnimationFrame,C=function(){function o(e,t,i){return i<0&&(i+=1),1<i&&--i,i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function a(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var i={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},n=function(e,t,i,r){this.r=a(e,1),this.g=a(t,1),this.b=a(i,1),this.a=a(r,1)||1};return n.parse=function(e){if("string"==typeof e){var t;if(e=e.toLowerCase(),t=(e=i[e]||e).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new n(parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255);if(t=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new n(parseFloat(t[1])/255,parseFloat(t[2])/255,parseFloat(t[3])/255,t[4]?parseFloat(t[5]):1)}return new n},n.fromHSL=function(e,t,i,r){return 0===t?new n(i,i,i,r):new n(o(i=2*i-(t=i<.5?i*(1+t):i+t-i*t),t,(e/=360)+1/3),o(i,t,e),o(i,t,e-1/3),r)},n.prototype={toHSL:function(){if(void 0!==this.r&&void 0!==this.g&&void 0!==this.b){var e,t=Math.max(this.r,this.g,this.b),i=Math.min(this.r,this.g,this.b),r=(t+i)/2,o=t-i;if(o){switch(i=.5<r?o/(2-t-i):o/(t+i),t){case this.r:e=(this.g-this.b)/o+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/o+2;break;case this.b:e=(this.r-this.g)/o+4}e*=60}else e=i=0;return{h:e,s:i,l:r,a:this.a}}},toString:function(){if(void 0!==this.r&&void 0!==this.g&&void 0!==this.b)return 1===this.a?"#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join()+")"},toArray:function(){if(void 0!==this.r&&void 0!==this.g&&void 0!==this.b)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return n.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return n.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return n.fromHSL(t.h,t.s,t.l*e)},red:function(e){return new n(this.r*e,this.g,this.b,this.a)},green:function(e){return new n(this.r,this.g*e,this.b,this.a)},blue:function(e){return new n(this.r,this.g,this.b*e,this.a)},alpha:function(e){return new n(this.r,this.g,this.b,this.a*e)},copy:function(){return new n(this.r,this.g,this.b,this.a)}},n}();"object"==typeof module&&(module.exports=C);var H,M,P,T,j,z,A,I,O,R,E,F,q,D,Z,N,B,V,W,J=(E=Math,F=E.PI,q=E.sin,D=E.cos,Z=E.tan,N=E.asin,B=E.atan2,W=23.4397*(V=F/180),function(e,t,i){i=V*-i,t*=V,e=e.valueOf()/864e5-.5+2440588-2451545;var r,o=V*(357.5291+.98560028*e);return r=o+(r=V*(1.9148*q(o)+.02*q(2*o)+3e-4*q(3*o)))+102.9372*V+F,o=N(q(0)*D(W)+D(0)*q(W)*q(r)),r=B(q(r)*D(W)-Z(0)*q(W),D(r)),e=V*(280.16+360.9856235*e)-i-r,{altitude:i=N(q(t)*q(o)+D(t)*D(o)*D(e)),azimuth:(t=B(q(e),D(e)*q(t)-Z(o)*D(t)))-F/2}}),X=function(){function y(e){return"#"===(e=e.toLowerCase())[0]?e:t[i[e]||e]||null}function h(e,t){var i,r,o,a,n,s=0;for(a=0,n=e.length-3;a<n;a+=2)i=e[a],r=e[a+1],o=e[a+2],s+=i*e[a+3]-o*r;if((0<s/2?"CW":"CCW")===t)return e;for(i=[],r=e.length-2;0<=r;r-=2)i.push(e[r],e[r+1]);return i}function m(e){var t,i,r,o=[];switch(e.type){case"GeometryCollection":for(o=[],t=0,i=e.geometries.length;t<i;t++)(r=m(e.geometries[t]))&&o.push.apply(o,r);return o;case"MultiPolygon":for(o=[],t=0,i=e.coordinates.length;t<i;t++)(r=m({type:"Polygon",coordinates:e.coordinates[t]}))&&o.push.apply(o,r);return o;case"Polygon":e=e.coordinates;break;default:return[]}var a,n=[],s=[];for(i=(a=e[t=0]).length;t<i;t++)n.push(a[t][1],a[t][0]);for(n=h(n,"CW"),t=0,i=e.length-1;t<i;t++){for(a=e[t+1],s[t]=[],o=0,r=a.length;o<r;o++)s[t].push(a[o][1],a[o][0]);s[t]=h(s[t],"CCW")}return[{outer:n,inner:s.length?s:null}]}var t={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},i={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};return{read:function(e){if(!e||"FeatureCollection"!==e.type)return[];var t,i,r,o,a,n,s,h,l=[];for(t=0,i=(e=e.features).length;t<i;t++)if("Feature"===(a=e[t]).type&&!1!==ke(a)){switch(r=(r=a.properties)||{},(o={}).height=r.height||(r.levels?3*r.levels:ce),o.minHeight=r.minHeight||(r.minLevel?3*r.minLevel:0),(n=r.material?y(r.material):r.wallColor||r.color)&&(o.wallColor=n),(n=r.roofMaterial?y(r.roofMaterial):r.roofColor)&&(o.roofColor=n),r.shape){case"cylinder":case"cone":case"dome":case"sphere":o.shape=r.shape,o.isRotational=!0;break;case"pyramid":o.shape=r.shape}switch(r.roofShape){case"cone":case"dome":o.roofShape=r.roofShape,o.isRotational=!0;break;case"pyramid":o.roofShape=r.roofShape}for(o.roofShape&&r.roofHeight?(o.roofHeight=r.roofHeight,o.height=b(0,o.height-o.roofHeight)):o.roofHeight=0,s=o,r=0,o=(n=m(a.geometry)).length;r<o;r++){h=s;var f={},c=void 0;for(c in h)h.hasOwnProperty(c)&&(f[c]=h[c]);if((h=f).footprint=n[r].outer,h.isRotational){f=h;for(var d=180,u=-180,g=0,p=(c=h.footprint).length;g<p;g+=2)d=x(d,c[g+1]),u=b(u,c[g+1]);f.radius=(u-d)/2}n[r].inner&&(h.holes=n[r].inner),(a.id||a.properties.id)&&(h.id=a.id||a.properties.id),a.properties.relationId&&(h.relationId=a.properties.relationId),l.push(h)}}return l}}}(),G=Math.PI,U=G/2,Y=G/4,$=0,K=0,Q=0,ee=0,te=0,ie=0,re=C.parse("rgba(200, 190, 180)"),oe=re.lightness(.8),ae=re.lightness(1.2),ne=""+re,se=""+oe,he=""+ae,le=0,fe=1,ce=5,de=(I={},O=[],R=0,{loadJSON:function(e,i){return function(t,i){if(!I[t]){var r=new XMLHttpRequest;return r.onreadystatechange=function(){if(4===r.readyState&&!(!r.status||r.status<200||299<r.status)&&i&&r.responseText){var e=r.responseText;for(I[t]=e,O.push({url:t,size:e.length}),R+=e.length,i(e);5242880<R;)e=O.shift(),R-=e.size,delete I[e.url]}},r.open("GET",t),r.send(null),r}i&&i(I[t])}(e,function(e){var t;try{t=JSON.parse(e)}catch(e){}i(t)})}}),ue={loadedItems:{},items:[],getPixelFootprint:function(e){for(var t,i=new k(e.length),r=0,o=e.length-1;r<o;r+=2)t=v(e[r],e[r+1]),i[r]=t.x,i[r+1]=t.y;o=(i=(e=i).length/2)-1;var a,n,s,h,l=[],f=[],c=[];for((t=new _(i))[r=0]=t[o]=1;o;){for(n=0,a=r+1;a<o;a++){s=e[2*a];var d=e[2*a+1],u=e[2*r],g=e[2*r+1],p=e[2*o],y=e[2*o+1],m=p-u,x=y-g,b=void 0;0===m&&0===x||(1<(b=((s-u)*m+(d-g)*x)/(m*m+x*x))?(u=p,g=y):0<b&&(u+=m*b,g+=x*b)),n<(s=(m=s-u)*m+(x=d-g)*x)&&(h=a,n=s)}2<n&&(t[h]=1,l.push(r),f.push(h),l.push(h),f.push(o)),r=l.pop(),o=f.pop()}for(a=0;a<i;a++)t[a]&&c.push(e[2*a],e[2*a+1]);if(!((i=c).length<8))return i},resetItems:function(){this.items=[],this.loadedItems={},ve.reset()},addRenderItems:function(e,t){for(var i,r,o,a=X.read(e),n=0,s=a.length;n<s;n++)o=(i=a[n]).id||[i.footprint[0],i.footprint[1],i.height,i.minHeight].join(),!this.loadedItems[o]&&(r=this.scale(i))&&(r.scale=t?0:1,this.items.push(r),this.loadedItems[o]=1);A||(A=setInterval(function(){for(var e=ue.items,t=!1,i=0,r=e.length;i<r;i++)e[i].scale<1&&(e[i].scale+=.1,1<e[i].scale&&(e[i].scale=1),t=!0);we.render(),t||(clearInterval(A),A=null)},33))},scale:function(e){var t={},i=6/w(2,H-15);if(e.id&&(t.id=e.id),t.height=x(e.height/i,P),t.minHeight=isNaN(e.minHeight)?0:e.minHeight/i,!(t.minHeight>P)&&(t.footprint=this.getPixelFootprint(e.footprint),t.footprint)){for(var r=1/0,o=-1/0,a=1/0,n=-1/0,s=0,h=(f=t.footprint).length-3;s<h;s+=2)r=x(r,f[s]),o=b(o,f[s]),a=x(a,f[s+1]),n=b(n,f[s+1]);if(t.center={x:r+(o-r)/2<<0,y:a+(n-a)/2<<0},e.radius&&(t.radius=e.radius*le),e.shape&&(t.shape=e.shape),e.roofShape&&(t.roofShape=e.roofShape),"cone"!==t.roofShape&&"dome"!==t.roofShape||t.shape||!function(e){var t=e.length;if(t<16)return!1;var i,r=1/0,o=-1/0,a=1/0,n=-1/0;for(i=0;i<t-1;i+=2)r=Math.min(r,e[i]),o=Math.max(o,e[i]),a=Math.min(a,e[i+1]),n=Math.max(n,e[i+1]);if((o=(i=o-r)/(n-=a))<.85||1.15<o)return!1;for(r={x:r+i/2,y:a+n/2},a=(i=(i+n)/4)*i,i=0;i<t-1;i+=2)if((n=d({x:e[i],y:e[i+1]},r))/a<.8||1.2<n/a)return!1;return!0}(t.footprint)||(t.shape="cylinder"),e.holes){t.holes=[];var l,f=0;for(r=e.holes.length;f<r;f++)(l=this.getPixelFootprint(e.holes[f]))&&t.holes.push(l)}var c;if(e.wallColor&&(c=C.parse(e.wallColor))&&(c=c.alpha(fe),t.altColor=""+c.lightness(.8),t.wallColor=""+c),e.roofColor&&(c=C.parse(e.roofColor))&&(t.roofColor=""+c.alpha(fe)),e.relationId&&(t.relationId=e.relationId),t.hitColor=ve.idToColor(e.relationId||e.id),t.roofHeight=isNaN(e.roofHeight)?0:e.roofHeight/i,!(t.height+t.roofHeight<=t.minHeight))return t}},set:function(e){this.isStatic=!0,this.resetItems(),this._staticData=e,this.addRenderItems(this._staticData,!0)},load:function(e,t){this.src=e||"https://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json".replace("{k}",t||"anonymous"),this.update()},update:function(){function e(e){n.addRenderItems(e)}if(this.resetItems(),!(H<15))if(this.isStatic&&this._staticData)this.addRenderItems(this._staticData);else if(this.src){var t,i=te/(a=16<H?256<<H-16:256>>16-H)<<0,r=ie/a<<0,o=m((te+$)/a),a=m((ie+K)/a),n=this;for(t=r;t<=a;t++)for(r=i;r<=o;r++)this.loadTile(r,t,16,e)}},loadTile:function(e,t,i,r){return e=this.src.replace("{s}","abcd"[(e+t)%4]).replace("{x}",e).replace("{y}",t).replace("{z}",i),de.loadJSON(e,r)}},ge={draw:function(e,t,i,r,o,a,n,s){var h,l=this._extrude(e,t,r,o,a,n),f=[];if(i)for(t=0,h=i.length;t<h;t++)f[t]=this._extrude(e,i[t],r,o,a,n);if(e.fillStyle=s,e.beginPath(),this._ring(e,l),i)for(t=0,h=f.length;t<h;t++)this._ring(e,f[t]);e.closePath(),e.stroke(),e.fill()},_extrude:function(e,t,i,r,o,a){i=450/(450-i);for(var n,s,h=450/(450-r),l={x:0,y:0},f={x:0,y:0},c=[],d=0,u=t.length-3;d<u;d+=2)l.x=t[d]-te,l.y=t[d+1]-ie,f.x=t[d+2]-te,f.y=t[d+3]-ie,n=me.project(l,i),s=me.project(f,i),r&&(l=me.project(l,h),f=me.project(f,h)),(f.x-l.x)*(n.y-l.y)>(n.x-l.x)*(f.y-l.y)&&(e.fillStyle=l.x<f.x&&l.y<f.y||l.x>f.x&&l.y>f.y?a:o,e.beginPath(),this._ring(e,[f.x,f.y,l.x,l.y,n.x,n.y,s.x,s.y]),e.closePath(),e.fill()),c[d]=n.x,c[d+1]=n.y;return c},_ring:function(e,t){e.moveTo(t[0],t[1]);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i],t[i+1])},simplified:function(e,t,i){if(e.beginPath(),this._ringAbs(e,t),i){t=0;for(var r=i.length;t<r;t++)this._ringAbs(e,i[t])}e.closePath(),e.stroke(),e.fill()},_ringAbs:function(e,t){e.moveTo(t[0]-te,t[1]-ie);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-te,t[i+1]-ie)},shadow:function(e,t,i,r,o){for(var a,n,s=null,h={x:0,y:0},l={x:0,y:0},f=0,c=t.length-3;f<c;f+=2)h.x=t[f]-te,h.y=t[f+1]-ie,l.x=t[f+2]-te,l.y=t[f+3]-ie,a=be.project(h,r),n=be.project(l,r),o&&(h=be.project(h,o),l=be.project(l,o)),(l.x-h.x)*(a.y-h.y)>(a.x-h.x)*(l.y-h.y)?(1===s&&e.lineTo(h.x,h.y),s=0,f||e.moveTo(h.x,h.y),e.lineTo(l.x,l.y)):(0===s&&e.lineTo(a.x,a.y),s=1,f||e.moveTo(a.x,a.y),e.lineTo(n.x,n.y));if(i)for(f=0,c=i.length;f<c;f++)this._ringAbs(e,i[f])},shadowMask:function(e,t,i){if(this._ringAbs(e,t),i){t=0;for(var r=i.length;t<r;t++)this._ringAbs(e,i[t])}},hitArea:function(e,t,i,r,o,a){i=null;var n={x:0,y:0},s={x:0,y:0};r=450/(450-r);var h,l=450/(450-o);e.fillStyle=a,e.beginPath();for(var f=0,c=t.length-3;f<c;f+=2)n.x=t[f]-te,n.y=t[f+1]-ie,s.x=t[f+2]-te,s.y=t[f+3]-ie,a=me.project(n,r),h=me.project(s,r),o&&(n=me.project(n,l),s=me.project(s,l)),(s.x-n.x)*(a.y-n.y)>(a.x-n.x)*(s.y-n.y)?(1===i&&e.lineTo(n.x,n.y),i=0,f||e.moveTo(n.x,n.y),e.lineTo(s.x,s.y)):(0===i&&e.lineTo(a.x,a.y),i=1,f||e.moveTo(a.x,a.y),e.lineTo(h.x,h.y));e.closePath(),e.fill()}},pe={draw:function(e,t,i,r,o,a,n,s,h){t={x:t.x-te,y:t.y-ie};var l=450/(450-o),f=450/(450-a);o=me.project(t,l),r*=l,a&&(t=me.project(t,f),i*=f),l=(l=this._tangents(t,i,o,r))?(a=p(l[0].y1-t.y,l[0].x1-t.x),p(l[1].y1-t.y,l[1].x1-t.x)):a=1.5*G,e.fillStyle=n,e.beginPath(),e.arc(o.x,o.y,r,U,a,!0),e.arc(t.x,t.y,i,a,U),e.closePath(),e.fill(),e.fillStyle=s,e.beginPath(),e.arc(o.x,o.y,r,l,U,!0),e.arc(t.x,t.y,i,U,l),e.closePath(),e.fill(),e.fillStyle=h,this._circle(e,o,r)},simplified:function(e,t,i){this._circle(e,{x:t.x-te,y:t.y-ie},i)},shadow:function(e,t,i,r,o,a){var n;t={x:t.x-te,y:t.y-ie},o=be.project(t,o),a&&(t=be.project(t,a));var s=this._tangents(t,i,o,r);s?(a=p(s[0].y1-t.y,s[0].x1-t.x),n=p(s[1].y1-t.y,s[1].x1-t.x),e.moveTo(s[1].x2,s[1].y2),e.arc(o.x,o.y,r,n,a),e.arc(t.x,t.y,i,a,n)):(e.moveTo(t.x+i,t.y),e.arc(t.x,t.y,i,0,2*G))},shadowMask:function(e,t,i){var r=t.x-te;t=t.y-ie,e.moveTo(r+i,t),e.arc(r,t,i,0,2*G)},hitArea:function(e,t,i,r,o,a,n){t={x:t.x-te,y:t.y-ie};var s=450/(450-o),h=450/(450-a);o=me.project(t,s),r*=s,a&&(t=me.project(t,h),i*=h),a=this._tangents(t,i,o,r),e.fillStyle=n,e.beginPath(),a?(n=p(a[0].y1-t.y,a[0].x1-t.x),s=p(a[1].y1-t.y,a[1].x1-t.x),e.moveTo(a[1].x2,a[1].y2),e.arc(o.x,o.y,r,s,n),e.arc(t.x,t.y,i,n,s)):(e.moveTo(t.x+i,t.y),e.arc(t.x,t.y,i,0,2*G)),e.closePath(),e.fill()},_circle:function(e,t,i){e.beginPath(),e.arc(t.x,t.y,i,0,2*G),e.stroke(),e.fill()},_tangents:function(e,t,i,r){if(!((f=(s=e.x-i.x)*s+(h=e.y-i.y)*h)<=(l=t-r)*l)){var o,a,n,s=-s/(f=y(f)),h=-h/f,l=l/f,f=[];o=y(b(0,1-l*l));for(var c=1;-1<=c;c-=2)a=s*l-c*o*h,n=h*l+c*o*s,f.push({x1:e.x+t*a<<0,y1:e.y+t*n<<0,x2:i.x+r*a<<0,y2:i.y+r*n<<0});return f}}},ye={draw:function(e,t,i,r,o,a,n){var s=450/(450-o);i=me.project({x:i.x-te,y:i.y-ie},450/(450-r)),r={x:0,y:0};for(var h={x:0,y:0},l=0,f=t.length-3;l<f;l+=2)r.x=t[l]-te,r.y=t[l+1]-ie,h.x=t[l+2]-te,h.y=t[l+3]-ie,o&&(r=me.project(r,s),h=me.project(h,s)),(h.x-r.x)*(i.y-r.y)>(i.x-r.x)*(h.y-r.y)&&(e.fillStyle=r.x<h.x&&r.y<h.y||r.x>h.x&&r.y>h.y?n:a,e.beginPath(),this._triangle(e,r,h,i),e.closePath(),e.fill())},_triangle:function(e,t,i,r){e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.lineTo(r.x,r.y)},_ring:function(e,t){e.moveTo(t[0]-te,t[1]-ie);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-te,t[i+1]-ie)},shadow:function(e,t,i,r,o){var a={x:0,y:0},n={x:0,y:0};i=be.project({x:i.x-te,y:i.y-ie},r),r=0;for(var s=t.length-3;r<s;r+=2)a.x=t[r]-te,a.y=t[r+1]-ie,n.x=t[r+2]-te,n.y=t[r+3]-ie,o&&(a=be.project(a,o),n=be.project(n,o)),(n.x-a.x)*(i.y-a.y)>(i.x-a.x)*(n.y-a.y)&&this._triangle(e,a,n,i)},shadowMask:function(e,t){this._ring(e,t)},hitArea:function(e,t,i,r,o,a){var n=450/(450-o);i=me.project({x:i.x-te,y:i.y-ie},450/(450-r)),r={x:0,y:0};var s={x:0,y:0};e.fillStyle=a,e.beginPath(),a=0;for(var h=t.length-3;a<h;a+=2)r.x=t[a]-te,r.y=t[a+1]-ie,s.x=t[a+2]-te,s.y=t[a+3]-ie,o&&(r=me.project(r,n),s=me.project(s,n)),(s.x-r.x)*(i.y-r.y)>(i.x-r.x)*(s.y-r.y)&&this._triangle(e,r,s,i);e.closePath(),e.fill()}},me={project:function(e,t){return{x:(e.x-T)*t+T<<0,y:(e.y-j)*t+j<<0}},render:function(){var e=this.context;if(e.clearRect(0,0,$,K),!(H<15||z)){var t,i,r,o,a,n,s,h={x:T+te,y:j+ie},l=ue.items;l.sort(function(e,t){return e.minHeight-t.minHeight||d(t.center,h)-d(e.center,h)||t.height-e.height});for(var f=0,c=l.length;f<c;f++)if(t=l[f],!xe.isSimple(t)&&u(o=t.footprint)){switch(i=t.scale<1?t.height*t.scale:t.height,r=0,t.minHeight&&(r=t.scale<1?t.minHeight*t.scale:t.minHeight),a=t.wallColor||ne,n=t.altColor||se,s=t.roofColor||he,e.strokeStyle=n,t.shape){case"cylinder":pe.draw(e,t.center,t.radius,t.radius,i,r,a,n,s);break;case"cone":pe.draw(e,t.center,t.radius,0,i,r,a,n);break;case"dome":pe.draw(e,t.center,t.radius,t.radius/2,i,r,a,n);break;case"sphere":pe.draw(e,t.center,t.radius,t.radius,i,r,a,n,s);break;case"pyramid":ye.draw(e,o,t.center,i,r,a,n);break;default:ge.draw(e,o,t.holes,i,r,a,n,s)}switch(t.roofShape){case"cone":pe.draw(e,t.center,t.radius,0,i+t.roofHeight,i,s,""+C.parse(s).lightness(.9));break;case"dome":pe.draw(e,t.center,t.radius,t.radius/2,i+t.roofHeight,i,s,""+C.parse(s).lightness(.9));break;case"pyramid":ye.draw(e,o,t.center,i+t.roofHeight,i,s,C.parse(s).lightness(.9))}}}}},xe={maxZoom:17,maxHeight:5,isSimple:function(e){return H<=this.maxZoom&&e.height+e.roofHeight<this.maxHeight},render:function(){var e=this.context;if(e.clearRect(0,0,$,K),!(H<15||z||H>this.maxZoom))for(var t,i,r=ue.items,o=0,a=r.length;o<a;o++)if(!((t=r[o]).height>=this.maxHeight)&&u(i=t.footprint))switch(e.strokeStyle=t.altColor||se,e.fillStyle=t.roofColor||he,t.shape){case"cylinder":case"cone":case"dome":case"sphere":pe.simplified(e,t.center,t.radius);break;default:ge.simplified(e,i,t.holes)}}},be={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(e,t){return{x:e.x+this.direction.x*t,y:e.y+this.direction.y*t}},render:function(){var e,t,i,r=this.context;if(r.clearRect(0,0,$,K),!(!this.enabled||H<15||z||(e=h(Q+te,ee+ie),(e=J(this.date,e.latitude,e.longitude)).altitude<=0))){var o,a,n,s;for(i=(t=1/c(e.altitude))<5?.75:1/t*5,this.direction.x=f(e.azimuth)*t,this.direction.y=l(e.azimuth)*t,e=ue.items,r.canvas.style.opacity=i/(2*fe),r.shadowColor=this.blurColor,r.shadowBlur=fe/2*this.blurSize,r.fillStyle=this.color,r.beginPath(),i=0,t=e.length;i<t;i++)if(u(s=(o=e[i]).footprint)){switch(a=o.scale<1?o.height*o.scale:o.height,n=0,o.minHeight&&(n=o.scale<1?o.minHeight*o.scale:o.minHeight),o.shape){case"cylinder":pe.shadow(r,o.center,o.radius,o.radius,a,n);break;case"cone":pe.shadow(r,o.center,o.radius,0,a,n);break;case"dome":pe.shadow(r,o.center,o.radius,o.radius/2,a,n);break;case"sphere":pe.shadow(r,o.center,o.radius,o.radius,a,n);break;case"pyramid":ye.shadow(r,s,o.center,a,n);break;default:ge.shadow(r,s,o.holes,a,n)}switch(o.roofShape){case"cone":pe.shadow(r,o.center,o.radius,0,a+o.roofHeight,a);break;case"dome":pe.shadow(r,o.center,o.radius,o.radius/2,a+o.roofHeight,a);break;case"pyramid":ye.shadow(r,s,o.center,a+o.roofHeight,a)}}for(r.closePath(),r.fill(),r.shadowBlur=null,r.globalCompositeOperation="destination-out",r.beginPath(),i=0,t=e.length;i<t;i++)if(u(s=(o=e[i]).footprint)&&!o.minHeight)switch(o.shape){case"cylinder":case"cone":case"dome":pe.shadowMask(r,o.center,o.radius);break;default:ge.shadowMask(r,s,o.holes)}r.fillStyle="#00ff00",r.fill(),r.globalCompositeOperation="source-over"}}},ve={_idMapping:[null],reset:function(){this._idMapping=[null]},render:function(){if(!this._timer){var e=this;this._timer=setTimeout(function(){e._timer=null,e._render()},500)}},_render:function(){var e=this.context;if(e.clearRect(0,0,$,K),!(H<15||z)){var t,i,r,o,a,n={x:T+te,y:j+ie},s=ue.items;s.sort(function(e,t){return e.minHeight-t.minHeight||d(t.center,n)-d(e.center,n)||t.height-e.height});for(var h=0,l=s.length;h<l;h++)if((a=(t=s[h]).hitColor)&&u(o=t.footprint)){switch(i=t.height,r=0,t.minHeight&&(r=t.minHeight),t.shape){case"cylinder":pe.hitArea(e,t.center,t.radius,t.radius,i,r,a);break;case"cone":pe.hitArea(e,t.center,t.radius,0,i,r,a);break;case"dome":pe.hitArea(e,t.center,t.radius,t.radius/2,i,r,a);break;case"sphere":pe.hitArea(e,t.center,t.radius,t.radius,i,r,a);break;case"pyramid":ye.hitArea(e,o,t.center,i,r,a);break;default:ge.hitArea(e,o,t.holes,i,r,a)}switch(t.roofShape){case"cone":pe.hitArea(e,t.center,t.radius,0,i+t.roofHeight,i,a);break;case"dome":pe.hitArea(e,t.center,t.radius,t.radius/2,i+t.roofHeight,i,a);break;case"pyramid":ye.hitArea(e,o,t.center,i+t.roofHeight,i,a)}}$&&K&&(this._imageData=this.context.getImageData(0,0,$,K).data)}},getIdFromXY:function(e,t){var i=this._imageData;if(i){var r=4*((0|t)*$+(0|e));return this._idMapping[i[r]|i[1+r]<<8|i[2+r]<<16]}},idToColor:function(e){var t=this._idMapping.indexOf(e);return-1===t&&(this._idMapping.push(e),t=this._idMapping.length-1),"rgb("+[255&t,t>>8&255,t>>16&255].join()+")"}},we={container:document.createElement("DIV"),items:[],init:function(){this.container.style.pointerEvents="none",this.container.style.position="absolute",this.container.style.left=0,this.container.style.top=0,be.context=this.createContext(this.container),xe.context=this.createContext(this.container),me.context=this.createContext(this.container),ve.context=this.createContext()},render:function(e){S(function(){e||(be.render(),xe.render(),ve.render()),me.render()})},createContext:function(e){var t=document.createElement("CANVAS");t.style.transform="translate3d(0, 0, 0)",t.style.imageRendering="optimizeSpeed",t.style.position="absolute",t.style.left=0,t.style.top=0;var i=t.getContext("2d");return i.lineCap="round",i.lineJoin="round",i.lineWidth=1,i.imageSmoothingEnabled=!1,this.items.push(t),e&&e.appendChild(t),i},appendTo:function(e){e.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(e,t){for(var i=0,r=this.items.length;i<r;i++)this.items[i].width=e,this.items[i].height=t},setPosition:function(e,t){this.container.style.left=e+"px",this.container.style.top=t+"px"}};we.init(),(i=(t=function(e){this.offset={x:0,y:0},e&&e.addLayer(this)}).prototype=L.Layer?new L.Layer:{}).addTo=function(e){return e.addLayer(this),this},i.onAdd=function(e){this.map=e,we.appendTo(e._panes.overlayPane);var t=this.getOffset(),i=e.getPixelOrigin();o({width:e._size.x,height:e._size.y});var r=i.y-t.y;te=i.x-t.x,ie=r,a(e._zoom),we.setPosition(-t.x,-t.y),e.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.on("zoomanim",this.onZoom,this),e.attributionControl&&e.attributionControl.addAttribution('&copy; <a href="https://osmbuildings.org">OSM Buildings</a>'),ue.update()},i.onRemove=function(){var e=this.map;e.attributionControl&&e.attributionControl.removeAttribution('&copy; <a href="https://osmbuildings.org">OSM Buildings</a>'),e.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.off("zoomanim",this.onZoom,this),we.remove()},i.onMove=function(e){e=this.getOffset(),r({x:this.offset.x-e.x,y:this.offset.y-e.y})},i.onMoveEnd=function(e){if(this.noMoveEnd)this.noMoveEnd=!1;else{var t=this.map;e=this.getOffset();var i=t.getPixelOrigin();this.offset=e,we.setPosition(-e.x,-e.y),r({x:0,y:0}),o({width:t._size.x,height:t._size.y}),t=i.y-e.y,te=i.x-e.x,ie=t,we.render(),ue.update()}},i.onZoomStart=function(e){z=!0,we.render()},i.onZoom=function(e){},i.onZoomEnd=function(e){e=this.map;var t=this.getOffset(),i=e.getPixelOrigin(),r=i.y-t.y;te=i.x-t.x,ie=r,e=e._zoom,z=!1,a(e),ue.update(),we.render(),this.noMoveEnd=!0},i.onResize=function(){},i.onViewReset=function(){var e=this.getOffset();this.offset=e,we.setPosition(-e.x,-e.y),r({x:0,y:0})},i.onClick=function(e){var t=ve.getIdFromXY(e.containerPoint.x,e.containerPoint.y);t&&_e({feature:t,lat:e.latlng.lat,lon:e.latlng.lng})},i.getOffset=function(){return L.DomUtil.getPosition(this.map._mapPane)},i.style=function(e){var t;return(t=(e=e||{}).color||e.wallColor)&&(re=C.parse(t),ne=""+re.alpha(fe),oe=re.lightness(.8),se=""+oe.alpha(fe),ae=re.lightness(1.2),he=""+ae.alpha(fe)),e.roofColor&&(ae=C.parse(e.roofColor),he=""+ae.alpha(fe)),void 0!==e.shadows&&(be.enabled=!!e.shadows),we.render(),this},i.date=function(e){return be.date=e,be.render(),this},i.load=function(e){return ue.load(e),this},i.set=function(e){return ue.set(e),this};var ke=function(){};i.each=function(t){return ke=function(e){return t(e)},this};var _e=function(){};i.click=function(t){return _e=function(e){return t(e)},this},t.VERSION="0.2.2b",t.ATTRIBUTION='&copy; <a href="https://osmbuildings.org">OSM Buildings</a>',e.OSMBuildings=t}(this);