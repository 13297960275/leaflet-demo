var widgetQY=L.widget.bindClass(L.widget.BaseWidget.extend({options:{resources:["qypopup.css"],view:{type:"window",url:"view.html",windowOptions:{width:330,height:400}}},isCluster:!1,create:function(){this.isCluster?this.layerWork=L.markerClusterGroup({chunkedLoading:!0,showCoverageOnHover:!1,disableClusteringAtZoom:11}):this.layerWork=L.featureGroup(),this.iconOnline=L.icon({iconUrl:this.path+"/img/qy.png",iconSize:[64,64],iconAnchor:[32,64]})},viewWindow:null,winCreateOK:function(i,a){this.viewWindow=a},activate:function(){map.addLayer(this.layerWork),this.layerWork.on("click",this.layerWork_clickHandler,this),map.on("click",this.closePopup,this),map.on("zoomend",this.map_zoomendHandler,this),this.queryData("")},disable:function(){this.closePopup(),this.layerWork.off("click",this.layerWork_clickHandler,this),map.removeLayer(this.layerWork),map.off("click",this.closePopup,this),map.off("zoomend",this.map_zoomendHandler,this)},map_zoomendHandler:function(i){},iconOnline:null,layerWork:null,objData:{},queryData:function(i){var a=this;$.getJSON("data/apidemo/qypoint.json",function(i){a.isActivate&&(a.showData(i),a.viewWindow.showData(a.objData))})},showData:function(i){if(this.objData={},this.layerWork.clearLayers(),null!=i&&0!=i.length)for(var a=0;a<i.length;a++){var e=this.addMarker(i[a]);this.objData[e.ID]=e}},addMarker:function(i){var a=Number(i.LONGITUDE),e=Number(i.LATITUDE);if(isNaN(a)||isNaN(e))i.visible=!1;else{var t;i.visible=!0;var o=L.src.pointconvert.gcj2wgs([a,e]);a=o[0],e=o[1],t=map.convert2map([e,a]);var r=L.marker(t,{icon:this.iconOnline});r.attr=i,this.layerWork.addLayer(r),i.feature=r}return i},centerAt:function(i){var a=this.objData[i];if(null!=a&&null!=a.feature){this.openPopup(a.feature);var e=a.feature.getLatLng();map.panTo(e,{animate:!1,duration:0});var t=map.getBounds(),o=t.getSouthWest(),r=t.getNorthEast(),n=(r.lng,o.lng,r.lat-o.lat);map.panTo([e.lat+n/4,e.lng],{animate:!1,duration:0})}else toastr.warning("该企业无坐标信息！")},updateMarkerVisible:function(i,a){for(var e=0;e<i.length;e++){var t=i[e].ID,o=this.objData[t];null!=o&&null!=o.feature&&(a?this.layerWork.addLayer(o.feature):this.layerWork.removeLayer(o.feature))}},markerPopup:null,layerWork_clickHandler:function(i){this.openPopup(i.layer)},openPopup:function(i){this.closePopup(),map.panTo(i.getLatLng());var a=i.attr,e=a.COUNTRY+a.REGION+a.ADDRESS,t=(a.COUNTRY_ENG||"")+" "+(a.REGION_ENG||"")+" "+(a.OFFICE_ENG||""),o=a.LOGO_URI;null!=o&&0!=o.length||(o=this.path+"/img/label.png");var r='<div class="qypopup"><div class="qypopup-content"><div class="qypopup-title">'+a.OFFICE+"</div>";r+='<div><div class="qypopup-img"><img src="'+o+'" width="150" height="140"/></div><div class="qypopup-rightinfo"><div class="qypopup-rightinfo_middle"><div>地址：'+e+"</div><div>入驻公司/部门："+a.DEPARTMENT+"</div><div>功能："+a.FUNCTION+'</div><div style="color: #666666;">'+t+'</div></div></div></div></div><div class="qypopup-close"  ></div></div>',this.markerPopup=L.marker(i.getLatLng(),{icon:L.divIcon({html:r,className:"qypopup_marker",iconSize:[500,325],iconAnchor:[105,390]}),pane:"popupPane"}).addTo(map),$(".qypopup-close").click(this.closePopup),$(".qypopup-content").click(function(i){L.DomEvent.stopPropagation(i)})},closePopup:function(){null!=this.markerPopup&&(map.removeLayer(this.markerPopup),this.markerPopup=null)}}));