L.widget.bindClass(L.widget.BaseWidget.extend({options:{resources:["map.css"],view:{type:"window",url:"view.html",windowOptions:{width:400,height:280}}},layerWork:null,layerText:null,create:function(){this.layerText=L.featureGroup()},viewWindow:null,winCreateOK:function(e,a){this.viewWindow=a},arrOldLayers:[],activate:function(){var t=this,a=[];for(var e in this.map.eachLayer(function(e){e instanceof L.TileLayer&&a.push(e)}),$.each(a,function(e,a){t.map.removeLayer(a)}),this.arrOldLayers=a,map.gisdata.controls)map.removeControl(map.gisdata.controls[e]);$("#location").hide(),$("#btnLayerMgr").hide(),$("#map").removeClass("leaflet-container"),$("#map").addClass("leaflet-mapbj"),this.layerWork&&map.addLayer(this.layerWork),map.addLayer(this.layerText),map.on("zoomend",this.map_zommendHandler,this),this.map_zommendHandler()},disable:function(){for(var e in $("#map").removeClass("leaflet-mapbj"),$("#map").addClass("leaflet-container"),map.gisdata.controls)map.addControl(map.gisdata.controls[e]);$("#location").show(),$("#btnLayerMgr").show();var t=this;$.each(this.arrOldLayers,function(e,a){t.map.addLayer(a)}),this.arrOldLayers=[],this.layerWork&&map.removeLayer(this.layerWork),map.removeLayer(this.layerText),map.off("zoomend",this.map_zommendHandler,this),document.getElementById("legendContainer")&&$("#legendContainer").remove()},map_zommendHandler:function(e){6<=map.getZoom()?map.addLayer(this.layerText):map.removeLayer(this.layerText)},addLayer:function(e,a){if(this.isActivate){this.featureCollection=e,this.selectData=a,this.addLegend();var o=this;null==this.layerWork?(this.layerWork=L.geoJson(this.featureCollection,{style:function(e){return{weight:2,opacity:1,color:"white",fillOpacity:.7,fillColor:e.properties.color}},onEachFeature:function(e,a){var t=e.properties,r="<div><h5>"+t.name+"</h5><span>"+o.selectData.title+"&nbsp;:&nbsp;"+t.num+o.selectData.unit+"</span></div>";a.bindTooltip(r),a.on({mouseover:function(e){var a=e.target;a.setStyle({weight:3,color:"#666",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||a.bringToFront(),o.viewWindow.showTip(a.feature.properties.shortname)},mouseout:function(e){var a=e.target;o.layerWork.resetStyle(a),o.viewWindow.hideTip(a.feature.properties.shortname)},click:function(e){map.fitBounds(e.target.getBounds())}})}}),map.addLayer(this.layerWork)):(this.layerWork.clearLayers(),this.layerWork.addData(this.featureCollection)),this.layerText.clearLayers();for(var t=this.layerWork.getLayers(),r=0;r<t.length;r++){var i=t[r],n=i.feature.properties,l=15*n.shortname.length,s=L.marker(i.getCenter(),{icon:L.divIcon({className:"leaflet-text-marker leaflet-text-marker-white",html:n.shortname,iconSize:[l,15]})});this.layerText.addLayer(s)}map.flyToBounds(this.layerWork.getBounds())}},showPolyTip:function(e){for(var a=this.layerWork.getLayers(),t=0;t<a.length;t++){var r=a[t];if(r.feature.properties.shortname==e){r.setStyle({weight:3,color:"#666",fillOpacity:.7}),r.openTooltip();break}}},hidePolyTip:function(e){for(var a=this.layerWork.getLayers(),t=0;t<a.length;t++){var r=a[t];if(r.feature.properties.shortname==e){this.layerWork.resetStyle(r),r.closeTooltip();break}}},addLegend:function(){var e=null;e=document.getElementById("legendContainer")?$("#legendContainer"):$('<div id="legendContainer" class="legend-container"></div>').appendTo($(document.body));var a="<div class='legend-title'>"+this.selectData.title+"("+this.selectData.unit+")</div>",t=this.selectData.span,r=this.viewWindow.colors,o=t.length;o>r.length&&(o=r.length);for(var i=0;i<=o;i++){var n=t[i];n=0==i?"小于"+t[i]:i==o?"大于"+t[i-1]:t[i-1]+"-"+t[i],a+="<div class='legend-item'><span class='legend-color' style='background:"+r[i]+"'></span><span class='legend-des'>"+n+"</span></div>"}$(e).html(a)}}));