L.widget.bindClass(L.widget.BaseWidget.extend({options:{view:{type:"window",url:"view.html",windowOptions:{width:300,height:500}}},workDraw:null,layerDraw:null,configBaidu:null,create:function(){var e=this;this.workDraw=new L.mars.Draw({map:map,isOnly:!0,style:{color:"#ff0000",weight:2},onEvnet:!1,onCreate:function(t){var a=t.layer;a instanceof L.Marker&&e.updateSelectMpt(a)},onChange:function(t){var a=e.workDraw.currEditFeature;a instanceof L.Marker&&e.updateSelectMpt(a)}}),this.layerDraw=this.workDraw.getLayer(),$.getJSON(this.path+"config.json",function(t){e.configBaidu=t})},viewWindow:null,winCreateOK:function(t,a){this.viewWindow=a},activate:function(){this.workDraw.onEvnet(),map.addLayer(this.layerDraw),this.layerWork&&map.addLayer(this.layerWork)},disable:function(){map.removeLayer(this.layerDraw),this.workDraw.destroy(),this.centerCircle&&(this.centerCircle.remove(),this.centerCircle=null),this.layerWork&&map.removeLayer(this.layerWork)},_lastRadius:1,centerCircle:null,startSelectMpt:function(t){this._lastRadius=t,this.workDraw.startDraw("marker")},updateSelectMpt:function(t){var a;latlng=t.getLatLng(),null==this.centerCircle?this.centerCircle=L.circle(latlng,{radius:this._lastRadius,color:"#ff0000",dashArray:"5, 10",stroke:!0,fill:!1}).addTo(map):this.centerCircle.setLatLng(latlng),map.centerAtLayer(this.centerCircle),latlng=map.convert2wgs(latlng),latlng=L.mars.pointconvert.wgs2bd([latlng[1],latlng[0]]),a=latlng[1]+","+latlng[0],this.viewWindow.selectMptEnd(a)},updateRadius:function(t){null!=this.centerCircle&&(this._lastRadius=t,this.centerCircle.setRadius(t))},_key_index:0,getKey:function(){var t=this._key_index++%this.configBaidu.key.length;return this.configBaidu.key[t]},queryParam:{},strartQueryPOI:function(t){this.queryParam=t,this.thispage=1,this.queryPOI()},queryPOI:function(){var a=this,t=this.getKey();$.ajax({url:this.configBaidu.url,type:"GET",dataType:"jsonp",timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",ak:t,scope:2,page_size:this.pageSize,page_num:this.thispage-1,query:this.queryParam.text,tag:this.queryParam.type,location:this.queryParam.location,radius:this.queryParam.radius},success:function(t){a.isActivate&&(0===t.status?a.showPOIPage(t.results,t.total):toastr.error("请求失败("+t.status+")："+t.message))},error:function(t){toastr.error("请求出错("+t.status+")："+t.statusText)}})},pageSize:20,arrdata:[],counts:0,allpage:0,thispage:0,showPOIPage:function(t,a){if(this.arrdata=t,this.counts=a,this.counts<t.length&&(this.counts=t.length),this.allpage=Math.ceil(this.counts/this.pageSize),0==this.counts)toastr.warning("当前查询条件下没有找到相关结果！");else for(var e=0;e<this.arrdata.length;e++){var i=this.arrdata[e],r=(this.thispage-1)*this.pageSize;i.index=r+(e+1),this.objResultData[e]=i}this.showPOIArr(this.arrdata),this.viewWindow.showPOIResult({pageSize:this.pageSize,allpage:this.allpage,thispage:this.thispage,counts:this.counts,arrdata:this.arrdata}),1==this.counts&&this.showDetail("0")},showFirstPage:function(){this.thispage=1,this.queryPOI()},showNextPage:function(){if(this.thispage=this.thispage+1,this.thispage>this.allpage)return this.thispage=this.allpage,void toastr.warning("当前已是最后一页了");this.queryPOI()},showPretPage:function(){if(this.thispage=this.thispage-1,this.thispage<1)return this.thispage=1,void toastr.warning("当前已是第一页了");this.queryPOI()},objResultData:{},showDetail:function(t){var a=this.objResultData[t];a.layer?this.centerAt(a.layer):toastr.warning('"'+name+'"无地理坐标信息！')},layerWork:null,getWorkLayer:function(){return null==this.layerWork&&(this.layerWork=L.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:14}).addTo(map)),this.layerWork},clearLayers:function(){null!=this.layerWork&&this.layerWork.clearLayers()},showPOIArr:function(t){var c=this.getWorkLayer();c.clearLayers(),$.each(t,function(t,a){var e=a.location.lng,i=a.location.lat;if(0<e&&0<i){var r,s=L.mars.pointconvert.bd2wgs([e,i]);e=s[0],i=s[1],r=map.convert2map([i,e]);var n=L.marker(r,{}),l='<div class="mars-popup-titile">'+((n.attributes=a).detail_info&&a.detail_info.detail_url?'<a href="'+a.detail_info.detail_url+'"  target="_black" style="color: #ffffff; ">'+a.name+"</a>":a.name)+'</div><div class="mars-popup-content" >',o=$.trim(a.telephone);""!=o&&(l+="<div><label>电话</label>"+o+"</div>");var h=$.trim(a.address);if(""!=h&&(l+="<div><label>地址</label>"+h+"</div>"),a.detail_info){var u=$.trim(a.detail_info.tag);""!=u&&(l+="<div><label>类别</label>"+u+"</div>")}l+="</div>",n.bindPopup(l),c.addLayer(n),a.layer=n}}),0<c.getLayers().length&&map.fitBounds(c.getBounds())},centerAt:function(t){var a=t.getLatLng();map.centerAt(a),t.openPopup()}}));