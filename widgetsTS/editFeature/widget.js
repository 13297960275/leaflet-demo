var widget_editFeature=L.widget.bindClass(L.widget.BaseWidget.extend({options:{resources:["../lib/jquery/jedate/skin/jedate.css","../lib/jquery/jedate/jedate.js"],view:{type:"window",url:"view.html",windowOptions:{width:300,height:500}}},layerEdit:null,layerFeature:null,workDraw:null,create:function(){var a=this;this.workDraw=new L.src.Draw({map:map,isOnly:!0,style:{color:"#ff0000",weight:2},onEvnet:!1,onCreate:function(e){a.viewWindow.startEnd();var t=e.layer;a.showTipInfo(t),a.addFeature(t)},onChange:function(e){var t=e.layer;a.showTipInfo(t),a.updateFeature(t)}}),this.layerEdit=this.workDraw.getLayer()},viewWindow:null,winCreateOK:function(e,t){this.viewWindow=t},activate:function(){this.workDraw.onEvnet(),map.addLayer(this.layerEdit),map.on("draw:drawing",this._map_draw_drawing,this),map.on("draw:editing",this._map_draw_editing,this)},disable:function(){map.off("draw:drawing",this._map_draw_drawing,this),map.off("draw:editing",this._map_draw_editing,this),this.workDraw.destroy(),this.removeFeatureLayer(),this.layerEdit.clearLayers(),map.removeLayer(this.layerEdit)},removeFeatureLayer:function(){null!=this.layerFeature&&(this.layerFeature.off("loading",this._layerFeature_loadingHndler,this),this.layerFeature.off("load",this._layerFeature_loadHndler,this),map.removeLayer(this.layerFeature),this.layerFeature=null)},objResultFeature:{},thisLayerCfg:null,getFeatureId:function(e){return e.id||e.properties.OBJECTID||e.properties.FID},showLayer:function(y){this.thisLayerCfg=y,this.removeFeatureLayer(),this.layerEdit.clearLayers(),y.type="arcgis_feature",this.layerFeature=L.src.layer.createLayer(y),this.layerFeature.unbindPopup();var w=this;this.layerFeature.bindPopup(function(e){for(var t=e.feature.properties,a='<div class="mars-popup-titile">'+y.name+'</div><div class="mars-popup-content" style="width:310px;" ><form class="form-horizontal">',r=0;r<y.columns.length;r++){var i,o=y.columns[r],n=o.name,s=o.field,l=t[s]||"",u="feature_"+s,d=!0;switch(o.hasOwnProperty("editable")&&(d=o.editable),o.type){default:i='<input type="text" id="'+u+'" class="form-control" value="'+l+'"  '+(d?"":"readonly")+" />";break;case"number":i='<input type="number"   id="'+u+'" class="form-control" value="'+l+'"  '+(d?"":"readonly")+" />";break;case"select":null==o.option&&0==o.option.length&&haouitl.alert(y.name+"图层的"+n+"字段是多项选择，请配置其option参数！"),i='<select id="'+u+'" class="form-control"    '+(d?"":"disabled")+'  > <option value ="" ></option>';for(var c=0;c<o.option.length;c++){var p=o.option[c];i+=' <option value ="'+p.value+'"  '+(p.value==l?'selected="selected"':"")+" >"+p.name+"</option>"}i+="</select>";break;case"datetime":if(i='<input type="text"   id="'+u+'" class="form-control dateinput dateicon je-mr25" value="'+l+'"  readonly/>',d){var h=u;setTimeout(function(){jeDate("#"+h,{theme:{bgcolor:"#20a0ff",pnColor:"#00CCFF"},format:"YYYY-MM-DD hh:mm:ss"})},500)}}a+=' <div class="form-group">  <label for="'+u+'" class="col-sm-3 control-label">'+n+'</label><div class="col-sm-8"> '+i+"</div> </div>"}var f=w.getFeatureId(e.feature);return a+='<div class="form-group"><div class="col-sm-offset-3 col-sm-9"><input type="button" class="btn btn-primary  btn-sm" value="保存" onclick="widget_editFeature.saveEditFeature('+f+')" />&nbsp;&nbsp;<input type="button" class="btn btn-danger  btn-sm" value="删除" onclick="widget_editFeature.deleteEditFeature('+f+')" /> </div></div>',a+="</form></div>"}),map.addLayer(this.layerFeature),this.layerFeature.on("loading",this._layerFeature_loadingHndler,this),this.layerFeature.on("load",this._layerFeature_loadHndler,this)},saveEditFeature:function(e){for(var t=this.objResultFeature[e],a=t.feature.properties,r=0;r<this.thisLayerCfg.columns.length;r++){var i=this.thisLayerCfg.columns[r],o=(i.name,i.field),n=$("#"+("feature_"+o)).val();switch(i.type){case"number":""==n&&(n=null),n=Number(n)}a[o]=n}this.updateFeature(t)},deleteEditFeature:function(e){this.deleteFeatures([e])},addFeature:function(r){r.feature=r.feature||{},r.feature.properties=r.feature.properties||{OBJECTID:0};var i=this;this.layerFeature.addFeature({type:"Feature",id:0,geometry:r.toGeoJSON().geometry,properties:r.feature.properties},function(e,t){if(null!=e&&0<e.code)toastr.error("错误代码"+e.code+":"+e.description,"FeatureServer新增错误");else if(t&&t.success){var a=t.objectId;r.feature.id=a,r.feature.properties.OBJECTID=a,i.objResultFeature[a]=r,toastr.success("添加成功!"),i.viewWindow.refData(i.objResultFeature)}})},updateFeature:function(e){var t=this.getFeatureId(e.feature),a=this;this.layerFeature.updateFeature({type:"Feature",id:t,geometry:e.toGeoJSON().geometry,properties:e.feature.properties},function(e,t){null!=e&&0<e.code?toastr.error("错误代码"+e.code+":"+e.description,"FeatureServer修改错误"):t&&t.success&&(toastr.warning("修改成功!"),a.viewWindow.refData(a.objResultFeature),a.layerFeature.closePopup())})},deleteFeatures:function(e){this.workDraw.stopDraw();var a=this;this.layerFeature.closePopup(),this.layerFeature.deleteFeatures(e,function(e,t){null!=e&&0<e.code?toastr.error("错误代码"+e.code+":"+e.description,"FeatureServer删除错误"):t&&0<t.length&&(toastr.success("删除成功!"),a.viewWindow.refData(a.objResultFeature))})},_layerFeature_loadingHndler:function(e){},_layerFeature_loadHndler:function(e){var a=this;a.layerEdit.clearLayers(),a.layerFeature.eachFeature(function(e){a.layerEdit.addLayer(e),a.bindDeleteContextmenu(e);var t=a.getFeatureId(e.feature);a.objResultFeature[t]=e}),a.viewWindow.showAllFrature(a.layerEdit.getLayers())},bindDeleteContextmenu:function(e){var a=this;e.bindContextMenu({contextmenu:!0,contextmenuInheritItems:!1,contextmenuItems:[{text:"删除",iconCls:"fa fa-trash",context:e,callback:function(e){var t=this.feature.id;a.deleteFeatures([t])}}]})},startAdd:function(e,t){var a;switch(e){case"marker":a=t.iconOptions;break;case"polyline":case"polygon":a=t.styleOptions}this.workDraw.startDraw(e,{style:a})},cacheAdd:function(){this.workDraw.stopDraw()},centerAt:function(e){var t=this.objResultFeature[e];map.centerAtLayer(t)},_map_draw_drawing:function(e){var t=e.layer,a=e.latlng;if(t instanceof L.Polyline){var r=t.getLatLngs().concat([a]);if(r.length<2)return;this.showTipInfo(L.polyline(r))}},_map_draw_editing:function(e){var t=e.layer;this.showTipInfo(t)},showTipInfo:function(e){}}));