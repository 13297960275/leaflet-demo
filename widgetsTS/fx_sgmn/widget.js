var zfdxSgmnWidget=L.widget.bindClass(L.widget.BaseWidget.extend({options:{resources:["../lib/leafletPlugins/_vector/l.ellipse.js","../lib/jquery/mCustomScrollbar/jquery.mCustomScrollbar.css","../lib/jquery/mCustomScrollbar/jquery.mCustomScrollbar.js","lib/drag.js","style.css"],view:[{type:"append",url:"view.html"}]},processBar:null,create:function(){},winCreateOK:function(t,e){var s=this;$("#btn_sgmn_close").click(function(t){s.disableBase()}),$("#sb").click(function(t){toastr.success("上报成功")}),$(".-l-a-info").mCustomScrollbar({theme:"minimal-dark"});this.processBar=new this._process({scale:["00",10,20,30,40,50,60],scaleID:"#-process-bottom-scale",scaleUnit:"",scaleInit:0,dragContainerID:"#process-bottom-drag",containerWidthPX:453,coefficient:10},function(t,e){}),$("#btn_sgmn_tsxd").click(function(){s.startTsxd()}),$("#btn_sgmn_start").click(function(){s.isStart?s.stopPlay():s.startPlay(!0)})},_process:function(l,n){var r=l.scale.length,c={scale:function(){for(var t="",e=l.scale,s=(l.containerWidthPX/(r-1)).toFixed(0),i=0;i<r;i++)i!=r-1&&(t+="<li t="+l.scale[i]+" style=width:"+s+"px>"+e[i]+l.scaleUnit+"</li>");$(l.scaleID).html(t)},drag:function(){var a=parseFloat(l.containerWidthPX/((r-1)*l.coefficient)),t=a*l.scaleInit,e='<div class=-process-bar style="width:'+(10+t)+'px;"></div><div class=-process-drag style="left:'+t+'px"></div>';$(l.dragContainerID).html(e),c.changeStyle(l.scaleInit),$(l.dragContainerID).children(".-process-drag").dragging({move:"x",moveHandler:function(t,e){var s=parseInt((t/a).toFixed(0)),i=$(this).parents("div");i.children(".-process-bar").css("width",t+10),i.children(".-process-mark").css("left",t),c.changeStyle(s),null!=n&&n(i,s)}})},setValue:function(t){var e=parseFloat(l.containerWidthPX/((r-1)*l.coefficient))*t;$(l.dragContainerID).children(".-process-bar").css("width",10+e),$(l.dragContainerID).children(".-process-mark").css("left",e),c.changeStyle(t)},changeStyle:function(e){$(l.scaleID).children().each(function(t){parseInt(this.getAttribute("t"))<e?$(this).removeClass("-u-gray"):$(this).addClass("-u-gray")})}};return c.scale(),c.drag(),c},setTimeSliderVal:function(t){this.processBar.setValue(t)},activate:function(){$("#view_sgmn").show(),$("#view_sgmn_timebar").show()},disable:function(){this.stopPlay(),this.layerCicles&&this.layerCicles.clearLayers(),this.layerPoint&&(map.removeLayer(this.layerPoint),this.layerPoint=null),$("#view_sgmn").hide(),$("#view_sgmn_timebar").hide()},point:null,layerPoint:null,startTsxd:function(){this.endTsxd(),map.on("click",this.onMapClick_tsxd,this),$(".leaflet-container").css("cursor","crosshair")},endTsxd:function(){map.off("click",this.onMapClick_tsxd,this),$(".leaflet-container").css("cursor","")},onMapClick_tsxd:function(t){this.endTsxd(),this.point=t.latlng,null==this.layerPoint?this.layerPoint=L.marker(this.point,{icon:L.icon({iconUrl:"img/marker/men3.png",iconSize:[32,44],iconAnchor:[16,44],popupAnchor:[0,-22]})}).addTo(map):this.layerPoint.setLatLng(this.point);var e=this.map.convert2wgs(this.point);$("#txt_sgmn_wz").val(e[0]+","+e[1])},layerCicles:null,interval:-1,isStart:!1,iNow:0,iALLTime:60,iALL:6,startPlay:function(t){if(null!=this.point){var e=Number($("#txt_sgmn_fs").val()),s=Number($("#txt_sgmn_fx").val()),i=Number($("#txt_sgmn_speed").val());if(isNaN(e)||0==e)layer.tips("请填写有效风速数据","#txt_sgmn_fs");else if(isNaN(s)||s<0||360<s)layer.tips("请填写有效风向数据(0-360)","#txt_sgmn_fx");else if(isNaN(i)||0==i)layer.tips("请填写有效速度数据","#txt_sgmn_speed");else{null==this.layerCicles&&(this.layerCicles=L.layerGroup().addTo(map)),t&&(this.iNow=0,this.layerCicles.clearLayers(),this.setTimeSliderVal(0)),this.isStart=!0,$("#btn_sgmn_start").html("停止模拟");var a=15/i,l=this;this.interval=setInterval(function(){if(l.iNow++,l.iNow>l.iALL||l.iNow<0)l.stopPlay();else{var t=l.iNow/l.iALL*l.iALLTime;l.setTimeSliderVal(t),l._addMnCicles(t,e,s)}},1e3*a)}}else toastr.warning("请在图上选择目标点后进行模拟！")},pausePlay:function(){this.isStart&&(clearInterval(this.interval),this.isStart=!1)},stopPlay:function(){this.isStart&&($("#btn_sgmn_start").html("开始模拟"),clearInterval(this.interval),this.isStart=!1)},_last_cicle:null,_addMnCicles:function(t,e,s){var i=60*t*e/1e3,a=s,l=turf.point([this.point.lng,this.point.lat]),n=turf.destination(l,i,a,{units:"kilometers"});n=[n.geometry.coordinates[1],n.geometry.coordinates[0]];var r=i/2,c=i,o=s+180;this._last_cicle=L.ellipse(n,[1e3*r,1e3*c],o,{color:"#ffffff",weight:1,fill:!0,fillColor:"#ff0000",fillOpacity:.4}).addTo(this.layerCicles),this.pausePlay();var h=this._last_cicle.getBounds();this.queryALL(h)},queryALL:function(t){map.fitBounds(t);this.clearResultLayers(),this.startPlay()},layerResult:null,getResultLayer:function(){return null==this.layerResult&&(this.layerResult=L.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:14}).addTo(map)),this.layerResult},clearResultLayers:function(){null!=this.layerResult&&this.layerResult.clearLayers()},isInCircle:function(t){if(null==this._last_cicle)return!1;var e=this._last_cicle.getRadius(),s=this._last_cicle.getLatLng(),i=Math.abs(s.distanceTo(t));return i<e.x||i<e.y},centerAt:function(t){var e=t.getLatLng();this.map.centerAt(e.lng,e.lat),t.openPopup()}}));