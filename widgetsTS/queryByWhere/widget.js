L.widget.bindClass(L.widget.BaseWidget.extend({options:{view:{type:"window",url:"view.html",windowOptions:{width:470,height:460}}},workDraw:null,layerDraw:null,layerWork:null,layerPoly:null,create:function(){this.layerWork=L.markerClusterGroup({chunkedLoading:!0,polygonOptions:{weight:1,color:"#03f",opacity:.5,fillOpacity:.1},disableClusteringAtZoom:16}),this.layerPoly=L.featureGroup([]),this.workDraw=new L.mars.Draw({map:map,isOnly:!0,style:{color:"#ff0000",weight:2},onEvnet:!1}),this.layerDraw=this.workDraw.getLayer()},viewWindow:null,winCreateOK:function(e,r){this.viewWindow=r},activate:function(){this.workDraw.onEvnet(),map.addLayer(this.layerWork),map.addLayer(this.layerPoly),map.addLayer(this.layerDraw)},disable:function(){this.clearShowFeature(),this.clearDraw(),map.removeLayer(this.layerWork),map.removeLayer(this.layerPoly),map.removeLayer(this.layerDraw),this.workDraw.destroy()},clearDraw:function(){this.workDraw.clearDraw(),this.workDraw.stopDraw()},drawPolygon:function(){this.workDraw.startDraw("polygon")},hasDraw:function(){return this.workDraw.hasDraw()},clearShowFeature:function(){this.layerWork.clearLayers(),this.layerPoly.clearLayers()},query:function(l){var e=L.esri.query({url:l.url});if(null!=l.where&&0<l.where.length&&e.where(l.where),"1"==l.extenttype){var n=this.workDraw.getDrawLayers();e.intersects(map.getBounds())}else"2"==l.extenttype&&(this.workDraw.stopDraw(),n=this.workDraw.getFeatures(),e.intersects(n.toGeoJSON()));var s=this;e.run(function(e,r,t){if(l.end(),null!=e&&0<e.code)toastr.error(e.message,"服务访问出错");else if(null!=r&&null!=r&&0!=r.features.length){null!=n&&n.setStyle({fill:!1});var a=[];for(i=0;i<r.features.length;i++){var o=r.features[i];null!=o&&null!=o.geometry&&null!=o.geometry.coordinates&&0!=o.geometry.coordinates.length&&a.push(o)}r.features=a,s.showQueryResult(r)}else toastr.info("未找到符合查询条件的要素！")})},objResultFeature:{},showQueryResult:function(e){this.clearShowFeature();for(var r=L.geoJSON(e).getLayers(),t=[],a=0;a<r.length;a++){var o=r[a],i=o.feature.properties,l="";for(var n in i){var s=$.trim(i[n]);if(null!=s&&""!=s&&"0"!=s&&0!=s.length){var w=this.viewWindow.getColumnCfgItem(n);null!=w&&(l+=w.name+":"+s+"<br/>")}}o.bindPopup(l),i.rowID=(a+1).toString(),i.geotype=o.feature.geometry.type,"Point"==o.feature.geometry.type?this.layerWork.addLayer(o):this.layerPoly.addLayer(o),t.push(i),this.objResultFeature[i.rowID]=o}this.viewWindow.showResult(t)},centerAt:function(e){var r=this.objResultFeature[e];map.centerAtLayer(r),r.openPopup()}}));